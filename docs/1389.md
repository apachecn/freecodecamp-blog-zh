# å¦‚ä½•ä½¿ç”¨ Netlify å’Œ Stripe è®¾ç½®æ— æœåŠ¡å™¨åœ¨çº¿æ”¯ä»˜

> åŸæ–‡ï¼š<https://www.freecodecamp.org/news/serverless-online-payments/>

è®¸å¤šå¹´è½»çš„åˆ›ä¸šå…¬å¸é‡‡å–çš„ç¬¬ä¸€æ­¥æ˜¯å»ºç«‹ä¸€ä¸ªé™æ€ç½‘é¡µï¼Œä¹Ÿè®¸æ˜¯ç”µå­é‚®ä»¶ç®€è®¯ï¼Œä»¥å¸®åŠ©ä»–ä»¬å»ºç«‹ä¸€ä¸ªè§‚ä¼—ç¾¤ã€‚

éšç€æ—¶é—´çš„æ¨ç§»ï¼ŒMVP çš„è¿›å±•è¶Šæ¥è¶Šå¿«ï¼Œå¦‚ä½•å¤„ç†æ”¯ä»˜çš„é—®é¢˜æœ€ç»ˆä¼šæµ®å‡ºæ°´é¢ã€‚

ä»ä¸€æ¬¡æ€§æ”¯ä»˜åˆ° SaaS è®¢é˜…ï¼Œæ”¯æŒåœ¨çº¿æ”¯ä»˜å¯èƒ½ä»¤äººç”Ÿç•ä¸”è€—æ—¶ã€‚è¿™ç¯‡æ–‡ç« å°†å‘æ‚¨ä»‹ç»ä¸€ç§ä½¿ç”¨ Stripe å¤„ç†åœ¨çº¿æ”¯ä»˜çš„ç®€å•æ–¹æ³•ï¼Œé™¤äº†é™æ€ç½‘é¡µä¹‹å¤–ï¼Œä¸éœ€è¦ä»»ä½•é¢å¤–çš„åŸºç¡€è®¾æ–½ã€‚

ä½ ä¸éœ€è¦å®šåˆ¶çš„åç«¯æ¥å­˜å‚¨æ”¯ä»˜ä¿¡æ¯ï¼Œä¹Ÿä¸éœ€è¦ cron ä½œä¸šæ¥å‘é€å‘ç¥¨ï¼Œä¹Ÿä¸éœ€è¦åœ¨å•ç‹¬çš„æ•°æ®åº“ä¸­è·Ÿè¸ªå®¢æˆ·ã€‚å¦‚æœä½ æ˜¯ä¸€ä¸ªå•ä¸€çš„åˆ›å§‹äººæˆ–æ—©æœŸé˜¶æ®µçš„åˆ›ä¸šå…¬å¸ï¼Œæƒ³è¦éªŒè¯è¿™ä¸ªæƒ³æ³•ï¼Œè€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªå®šåˆ¶çš„è§£å†³æ–¹æ¡ˆï¼Œè¿™æ˜¯å®Œç¾çš„ã€‚

å¬èµ·æ¥ä¸é”™ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹å§ï¼ğŸ¤¿

## é¡¹ç›®çš„é«˜çº§æ¦‚è¿°

å‡ºäºæœ¬æ–‡çš„è€ƒè™‘ï¼Œæˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ªæ—©æœŸå¯åŠ¨ç”¨ä¾‹ï¼Œå…¶ä¸­è¿™ç§æ— æœåŠ¡å™¨åœ¨çº¿æ”¯ä»˜è®¾ç½®å°†å¸¦æ¥æœ€å¤§çš„ä»·å€¼(ä½æˆæœ¬å’Œå¿«é€Ÿå®ç°)ã€‚

å‡è®¾æˆ‘ä»¬çš„åˆ›ä¸šæƒ³æ³•æ˜¯è‡ªåŠ©å‡ºç‰ˆä¸€æœ¬ä¹¦ã€‚ç”±äºè¿™æœ¬ä¹¦æ­£åœ¨å®šç¨¿ï¼Œæˆ‘ä»¬æƒ³å¼€æ”¾è¿™æœ¬ä¹¦çš„ç»ˆèº«è®¿é—®ä½œä¸ºé¢„å”®ã€‚

æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•æ¥å¤„ç†ç»ˆèº«è®¿é—®è¿™æœ¬ä¹¦çš„ä»˜æ¬¾ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ”¯ä»˜å¤„ç†å™¨ï¼Œä¹Ÿè®¸è¿˜éœ€è¦ä¸€ç§æ–¹æ³•æ¥è¿è¡Œä¸€äº›è¿œç¦»å®¢æˆ·ç«¯çš„é€»è¾‘(ä¾‹å¦‚ï¼Œåˆ©ç”¨æ”¯ä»˜å¤„ç†å™¨çš„ API)ã€‚

### æ”¯ä»˜å¤„ç†å™¨

æœ‰å¤§é‡çš„æ”¯ä»˜å¤„ç†å™¨å¯ç”¨ï¼Œæ¯ä¸€ä¸ªéƒ½æœ‰ä¸åŒçš„æ¡æ¬¾ã€å¯¹æ”¯ä»˜æ–¹å¼çš„æ”¯æŒå’Œå…¬å…± APIã€‚å¯¹äºæˆ‘ä»¬çš„æ— æœåŠ¡å™¨åœ¨çº¿æ”¯ä»˜å¤„ç†å™¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ [Stripe](https://stripe.com/) ã€‚æˆ‘é€‰æ‹©ä½¿ç”¨ Stripe æœ‰ä¸¤ä¸ªåŸå› :

é¦–å…ˆï¼ŒStripe æ˜¯ä¸šç•Œé¢†å…ˆçš„æ”¯ä»˜å¤„ç†å™¨ï¼Œå…·æœ‰å‡ºè‰²çš„ APIã€‚ä»–ä»¬çš„ API è¢«å¹¿æ³›åœ°æ–‡æ¡£åŒ–ï¼Œå¹¶ä¸”ä»–ä»¬ä¸ºè®¸å¤šè¯­è¨€(åŒ…æ‹¬ JS)æä¾›é›†æˆ SDKã€‚è®¾ç½®å®ƒæ˜¯å®Œå…¨å…è´¹çš„ï¼Œä½ åªéœ€ä¸ºæ¯ç¬”äº¤æ˜“æ”¯ä»˜ä¸€å°ç¬”ä½£é‡‘ã€‚

å…¶æ¬¡ï¼ŒStripe æä¾› Stripe Checkoutï¼Œè¿™æ˜¯ä¸€æ¬¾å…è´¹äº§å“ï¼Œä¸“ä¸ºæé«˜è½¬åŒ–ç‡å’Œæ”¯æŒå„ç§æ”¯ä»˜é€‰é¡¹è€Œæ‰“é€ ã€‚å®ƒé›†æˆèµ·æ¥éå¸¸ç®€å•ï¼Œè€Œä¸”æœ‰ä¸€ä¸ªå¾ˆæ£’çš„ UIã€‚

### æœåŠ¡å™¨å‘¢ï¼Ÿ

æ˜ç¡®åœ°è¯´ï¼Œä¸€æ—¦ç”¨æˆ·è¾“å…¥æ”¯ä»˜æ•°æ®ï¼ŒStripe éœ€è¦ä¸€äº›æœåŠ¡å™¨ç«¯ä»£ç æ¥ç”Ÿæˆä¼šè¯ã€‚å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨è¯¥ä¼šè¯æ¥æ‰§è¡Œä¸æ”¯ä»˜ç›¸å…³çš„æ“ä½œ(è€Œä¸ä¼šæš´éœ²æ•æ„Ÿçš„æ”¯ä»˜ç»†èŠ‚)ã€‚

åœ¨ä½ çœŸçš„å¯¹æˆ‘å¤±æœ›ä¹‹å‰ï¼Œè®©æˆ‘æ¾„æ¸…ä¸€ä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦å»ºç«‹ä¸€ä¸ªä¸“ç”¨çš„æœåŠ¡å™¨ğŸ˜…ã€‚è¿™å¯èƒ½çœ‹èµ·æ¥æœ‰ç‚¹çŸ›ç›¾ï¼Œä½†æ˜¯ Stripe è¦æ±‚ä¸€äº›äº¤äº’ä»£ç å¤„äºç±»ä¼¼äºç¯å¢ƒçš„æœåŠ¡å™¨- **(æ— æœåŠ¡å™¨è®¡ç®—æ¥æ‹¯æ•‘ï¼).**

å¹¸è¿çš„æ˜¯ï¼Œç°åœ¨æ˜¯ 2021 å¹´ï¼Œæœ‰ç›¸å½“å¤šçš„é€‰é¡¹å¯ä»¥æŒ‰éœ€æ‰§è¡ŒæœåŠ¡å™¨ç«¯ä»£ç ã€‚å¤§å¤šæ•°äº‘æä¾›å•†éƒ½æä¾›è¿™ç§åŠŸèƒ½(AWS lambdasã€Google Cloud äº‘å‡½æ•°ã€Azure å‡½æ•°â€¦â€¦ä½ èƒ½æƒ³åˆ°çš„éƒ½æœ‰)ã€‚

ç”±äºæˆ‘ä»¬çš„åˆåˆ›å…¬å¸å·²ç»æœ‰äº†ä¸€ä¸ªç½‘é¡µï¼Œæˆ‘ä»¬å°†ä½¿ç”¨[ç½‘ç»œåŠŸèƒ½](https://www.netlify.com/products/functions/)ã€‚å®ƒå°†å…è®¸æˆ‘ä»¬å‡ ä¹ä¸éœ€è¦é¢å¤–çš„é…ç½®å°±å¯ä»¥è¿è¡ŒæœåŠ¡å™¨ç«¯ä»£ç ï¼Œå¹¶ä¸”å®ƒå¯ä»¥å¾ˆå¥½åœ°å¤„ç†ç°æœ‰çš„ web é¡µé¢é™æ€æ•°æ®ã€‚

å°†é™æ€ web èµ„äº§ä¸æŒ‰éœ€æ— æœåŠ¡å™¨åŠŸèƒ½ç›¸ç»“åˆçš„èŒƒä¾‹æ˜¯ [JAM Stack](https://jamstack.org/) çš„ä¸€éƒ¨åˆ†(æˆ‘ä»¬å°†åœ¨å¦ä¸€ç¯‡æ–‡ç« ä¸­è®¨è®º)ã€‚è¯·ç»§ç»­é˜…è¯»å¦‚ä½•è®¾ç½®æ— æœåŠ¡å™¨æ”¯ä»˜çš„è¯¦ç»†è¯´æ˜ã€‚

![s_16ACAF73564EBCEEB7494C6A4225B10D5BBA9580C5BBD5452113AF0E1E7CCE6B_1635610448861_image](img/d009baf40defbb9b7bbce32223525f03.png)

High-level schema of the solution

# é€æ­¥é¡¹ç›®è®¾ç½®

å¾ˆå¥½ï¼Œç°åœ¨ä½ å·²ç»å¯¹é—®é¢˜ç©ºé—´å’Œæˆ‘ä»¬å°†ç”¨æ¥æ„å»ºè§£å†³æ–¹æ¡ˆçš„å·¥å…·æœ‰äº†æ¸…æ™°çš„äº†è§£ï¼Œè®©æˆ‘ä»¬æ¥æ„å»ºå®ƒã€‚ğŸ› 

å®Œæ•´çš„ä»£ç ç¤ºä¾‹å¯åœ¨[https://github.com/aperkaz/serverless-payments](https://github.com/aperkaz/serverless-payments)è·å¾—ã€‚

### å¦‚ä½•è®¾ç½®ç½‘ç»œç”Ÿæ´»

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ª [Netlify](https://www.netlify.com/) è´¦æˆ·(å¦‚æœä½ è¿˜æ²¡æœ‰çš„è¯)ã€‚å…è´¹å±‚è¶³ä»¥æ»¡è¶³ä¸­ç­‰ç¨‹åº¦çš„ä½¿ç”¨ï¼Œå› æ­¤æ— éœ€æ‹…å¿ƒã€‚

Netlify é€šè¿‡è¿æ¥åˆ° Github / Gitlab / Bitbucket ä¸­çš„ Git repoï¼Œä¸ºæˆ‘ä»¬çš„ç½‘é¡µå’Œæ— æœåŠ¡å™¨åŠŸèƒ½çš„è‡ªåŠ¨éƒ¨ç½²æä¾› CI/CDã€‚å› æ­¤ï¼Œè®©æˆ‘ä»¬ç”¨æ‚¨çš„ç½‘ç«™èµ„äº§åœ¨å…¶ä¸­ä¸€ä¸ªæä¾›å•†å¤„åˆ›å»ºä¸€ä¸ªå›è´­ã€‚

æ¥ä¸‹æ¥ï¼Œå®‰è£… [Netlify CLI](https://cli.netlify.com/getting-started/) ã€‚å®ƒä¼šé—®ä½ ä¸€äº›é—®é¢˜ï¼Œå¹¶è¯·æ±‚è®¿é—®ä½ çš„ Netlify å’Œ Git repo æä¾›è€…(åœ¨æˆ‘çš„ä¾‹å­ä¸­æ˜¯ GitHub)ã€‚

![s_16ACAF73564EBCEEB7494C6A4225B10D5BBA9580C5BBD5452113AF0E1E7CCE6B_1635614098858_Screenshot+2021-10-30+at+19.14.47](img/d4a0e2abd51a3a198bab83d805c7a4af.png)

*Installing the CLI with* `npm install netlify-cli -g`

æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ¨é€åˆ°å­˜å‚¨åº“çš„`main` / `master`åˆ†æ”¯ï¼ŒNetlify ä¼šè‡ªåŠ¨éƒ¨ç½²ã€‚ä½ å¯ä»¥åœ¨æ§åˆ¶å°è¿è¡Œ`netlify open`æ‰“å¼€ Netlify çš„ç®¡ç†é¢æ¿ï¼Œè®¿é—®éƒ¨ç½²çš„ URLã€‚

![s_16ACAF73564EBCEEB7494C6A4225B10D5BBA9580C5BBD5452113AF0E1E7CCE6B_1635614710558_Screenshot+2021-10-30+at+19.19.40](img/b32e2034fbf47e94c2b5e026780bbe09.png)

å¾ˆå¥½ï¼Œè‡ªåŠ¨éƒ¨ç½²å‡†å¤‡å°±ç»ªï¼Œç°åœ¨è®©æˆ‘ä»¬è®¾ç½®æ¡å¸¦ã€‚ğŸ’¸

### å¦‚ä½•è®¾ç½®æ¡çº¹

åœ¨ Stripe ä¸­åˆ›å»ºä¸€ä¸ªå¸æˆ·ï¼ŒéªŒè¯ç”µå­é‚®ä»¶ï¼Œç„¶åç™»å½•ã€‚ç„¶åï¼Œ[ç”Ÿæˆä¸€ç»„ API å¯†é’¥](https://stripe.com/docs/keys)(ç§˜å¯†å¯†é’¥å’Œå¯å…¬å¼€å¯†é’¥)ã€‚

æ‚¨å¿…é¡»å°å¿ƒä½¿ç”¨è¿™äº›å¯†é’¥ï¼Œå¹¶ä¸”æ°¸è¿œä¸è¦åœ¨ä»£ç ä¸­æäº¤å¯†é’¥ã€‚å› ä¸ºæˆ‘ä»¬å°†åœ¨æœåŠ¡å™¨ç«¯ä»£ç ä¸­éœ€è¦å®ƒï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒä½œä¸ºä¸€ä¸ª[ç¯å¢ƒå˜é‡](https://www.netlify.com/blog/2021/07/12/managing-environment-variables-from-your-terminal-with-netlify-cli/)ä¿å­˜ã€‚

```
# Create a new env variable in Netlify
netlify env:set STRIPE_SECRET "sk_****"

# We can access it on our server-side JS code by:
process.env.STRIPE_SECRET
```

å‡ºäºæœ¬æ•™ç¨‹çš„è€ƒè™‘ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨[ç¤ºä¾‹ API é”®](https://stripe.com/docs/payments/accept-a-payment?integration=checkout#set-up-stripe)ï¼Œä½†ä¹Ÿå¯ä»¥éšæ„ä½¿ç”¨æ‚¨è‡ªå·±çš„é”®ã€‚å¦‚æœæ‚¨ä½¿ç”¨æ‚¨çš„å¯†é’¥ï¼Œæ‚¨å°†éœ€è¦æ·»åŠ äº§å“å’Œä»·æ ¼([æ–‡æ¡£](https://support.stripe.com/questions/how-to-create-products-and-prices))ã€‚

### å¦‚ä½•æ·»åŠ æ— æœåŠ¡å™¨åŠŸèƒ½

æŠ“ç´§äº†ï¼Œæˆ‘ä»¬å¿«åˆ°äº†ï¼æˆ‘ä»¬åªéœ€è¦æœåŠ¡å™¨ç«¯ä»£ç æ¥åˆ›å»ºæ¡å¸¦æ£€å‡ºä¼šè¯å¹¶å®Œæˆæˆ‘ä»¬çš„æ¼”ç¤ºã€‚

é¦–å…ˆï¼Œä¸ºäº†è®©æˆ‘ä»¬çš„åŠŸèƒ½å¯ä»¥ä»[https://serverless-payments.netlify.app/api/stripe](https://serverless-payments.netlify.app/api/stripe)è®¿é—®ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€äº›é…ç½®ã€‚è®©æˆ‘ä»¬ä»åœ¨ repo çš„æ ¹ç›®å½•ä¸‹åˆ›å»º`netlify.toml`æ–‡ä»¶å¼€å§‹ã€‚

```
[build]
  command = "# no build command"
  functions = "netlify/functions"
  publish = "."

[[redirects]]
  from = '/api/*'
  to = '/.netlify/functions/:splat'
  status = 200
```

ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ä¼šè¯åˆ›å»ºè€…åŠŸèƒ½ã€‚è¿™é‡Œè§£é‡Š[ã€‚](https://stripe.com/docs/payments/accept-a-payment?integration=checkout#set-up-stripe)

```
// netlify/function/stripe.js

const stripe = require("stripe")(process.env.STRIPE_SECRET);

exports.handler = async (event, context) => {
  const session = await stripe.checkout.sessions.create({
    payment_method_types: ["card"],
    line_items: [
      {
        price_data: {
          currency: "usd",
          product_data: {
            name: "T-shirt",
          },
          unit_amount: 2000,
        },
        quantity: 1,
      },
    ],
    mode: "payment",
    success_url: "https://serverless-payments.netlify.app/success",
    cancel_url: "https://serverless-payments.netlify.app/cancel",
  });
  return {
    statusCode: 200,
    body: JSON.stringify({
      id: session.id,
    }),
  };
};
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥ç”¨`fetch("/api/stripe")`ä» JS ä¸»ä½“è°ƒç”¨æ— æœåŠ¡å™¨å‡½æ•°ã€‚å®ƒå°†æ ¹æ®è´Ÿè½½è¿›è¡Œæ‰©å±•ï¼Œæ‚¨åªéœ€ä¸ºè°ƒç”¨ä»˜è´¹ã€‚é‚£ä¹ˆå®ƒå°†åœ¨æ¯æ¬¡æ¨é€åˆ°`main`æ—¶è¢«éƒ¨ç½²ã€‚å¤ªæ£’äº†ã€‚ğŸ¬

ä¸ºäº†ç®€æ´èµ·è§ï¼Œæˆ‘è·³è¿‡äº† HTML æ–‡ä»¶ä¸­å¤„ç†æ¡å¸¦æ£€å‡ºå›è°ƒçš„å‰©ä½™ä»£ç ã€‚ä»£ç å¯åœ¨[è¿™é‡Œ](https://github.com/aperkaz/serverless-payments)è·å¾—ã€‚

å®Œæ•´çš„ä¾‹å­å¯ä»¥åœ¨[https://server less-payments . net lify . app](https://serverless-payments.netlify.app/)ä¸Šæ‰¾åˆ°ã€‚æ‚¨å¯ä»¥ä½¿ç”¨`4242 4242 4242 4242`ä½œä¸ºä¿¡ç”¨å¡å·æ¥æµ‹è¯•æˆåŠŸçš„æ”¯ä»˜æµç¨‹ã€‚

![s_16ACAF73564EBCEEB7494C6A4225B10D5BBA9580C5BBD5452113AF0E1E7CCE6B_1635620255253_Screenshot+2021-10-30+at+20.57.20](img/9a4b57ffda6c38732a173e194a8a69cb.png)

Stripe Checkout in all its glory, accessible from [our page](https://serverless-payments.netlify.app)

## ç»“è®º

åœ¨çº¿æ”¯ä»˜å¯¹è®¸å¤šåœ¨çº¿ä¸šåŠ¡æ¥è¯´è‡³å…³é‡è¦ï¼Œä½†é€šå¸¸æ˜¯ä»“ä¿ƒå®æ–½æˆ–è¿‡åº¦è®¾è®¡ã€‚ä¸Šé¢ä»‹ç»çš„è§£å†³æ–¹æ¡ˆé€‚ç”¨äºå•é¡µé¢åº”ç”¨ç¨‹åºï¼Œå› æ­¤æ‚¨å¯èƒ½è¿˜ä¸éœ€è¦ä¸€ä¸ªæˆç†Ÿçš„æœåŠ¡å™¨æ¥å¤„ç†æ”¯ä»˜ã€‚ğŸ™‚

æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿå¸®åŠ©æ‚¨è½»æ¾åœ°å°†æ”¯ä»˜å¤„ç†æ·»åŠ åˆ°ç°æœ‰çš„ web é¡µé¢ä¸­ã€‚å¿«é€Ÿé”€å”®æ‚¨çš„äº§å“ï¼Œè®©å®¢æˆ·æ»¡æ„ï¼