# åŒæ­¥ä¸å¼‚æ­¥ JavaScriptâ€”â€”è°ƒç”¨å †æ ˆã€æ‰¿è¯ºç­‰ç­‰

> åŸæ–‡ï¼š<https://www.freecodecamp.org/news/synchronous-vs-asynchronous-in-javascript/>

è®©æˆ‘ä»¥é—®â€œä»€ä¹ˆæ˜¯ JavaScriptâ€å¼€å§‹è¿™ç¯‡æ–‡ç« ã€‚å¥½å§ï¼Œè¿™æ˜¯æˆ‘è¿„ä»Šä¸ºæ­¢å‘ç°çš„æœ€ä»¤äººå›°æƒ‘çš„ä¸­è‚¯ç­”æ¡ˆ:

> JavaScript æ˜¯ä¸€ç§å•çº¿ç¨‹ã€éé˜»å¡ã€å¼‚æ­¥ã€å¹¶å‘ç¼–ç¨‹è¯­è¨€ï¼Œå…·æœ‰å¾ˆå¤§çš„çµæ´»æ€§ã€‚

ç­‰ç­‰ï¼Œå®ƒæ˜¯ä¸æ˜¯åŒæ—¶è¯´äº†å•çº¿ç¨‹å’Œå¼‚æ­¥ï¼Ÿå¦‚æœæ‚¨ç†è§£å•çº¿ç¨‹çš„å«ä¹‰ï¼Œæ‚¨å¯èƒ½ä¼šå°†å®ƒä¸åŒæ­¥æ“ä½œè”ç³»èµ·æ¥ã€‚é‚£ä¹ˆï¼ŒJavaScript æ€ä¹ˆå¯èƒ½æ˜¯å¼‚æ­¥çš„å‘¢ï¼Ÿ

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹  JavaScript çš„åŒæ­¥å’Œå¼‚æ­¥éƒ¨åˆ†ã€‚åœ¨ web ç¼–ç¨‹ä¸­ï¼Œæ‚¨å‡ ä¹æ¯å¤©éƒ½ä¼šç”¨åˆ°è¿™ä¸¤è€…ã€‚

å¦‚æœæ‚¨ä¹Ÿå–œæ¬¢ä»è§†é¢‘å†…å®¹ä¸­å­¦ä¹ ï¼Œæœ¬æ–‡ä¹Ÿå¯ä»¥ä½œä¸ºè§†é¢‘æ•™ç¨‹åœ¨æ­¤å¤„è·å¾—:ğŸ™‚

[https://www.youtube.com/embed/pIjfzjsoVw4?feature=oembed](https://www.youtube.com/embed/pIjfzjsoVw4?feature=oembed)

# åœ¨æœ¬æ–‡ä¸­ï¼Œæ‚¨å°†äº†è§£åˆ°:

*   JavaScript æ˜¯å¦‚ä½•åŒæ­¥çš„ã€‚
*   JavaScript å•çº¿ç¨‹æ—¶å¼‚æ­¥æ“ä½œæ˜¯å¦‚ä½•å‘ç”Ÿçš„ã€‚
*   ç†è§£åŒæ­¥å’Œå¼‚æ­¥å¦‚ä½•å¸®åŠ©æ‚¨æ›´å¥½åœ°ç†è§£ JavaScript æ‰¿è¯ºã€‚
*   å¤§é‡ç®€å•ä½†å¼ºå¤§çš„ä¾‹å­è¯¦ç»†ä»‹ç»äº†è¿™äº›æ¦‚å¿µã€‚

# JavaScript å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘

åœ¨ JavaScript ä¸­ï¼Œæ‚¨å¯ä»¥åˆ›å»ºå’Œä¿®æ”¹ä¸€ä¸ªå‡½æ•°ï¼Œå°†å®ƒç”¨ä½œå‚æ•°ï¼Œä»å¦ä¸€ä¸ªå‡½æ•°è¿”å›å®ƒï¼Œå¹¶å°†å®ƒèµ‹ç»™ä¸€ä¸ªå˜é‡ã€‚æ‰€æœ‰è¿™äº›èƒ½åŠ›å…è®¸æˆ‘ä»¬åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨å‡½æ•°æ¥é€»è¾‘åœ°æ”¾ç½®ä¸€å †ä»£ç ã€‚

![block-function](img/cc0436f39d1ddc0bc8b796229e11e573.png)

Lines of code organized into functions logically

æˆ‘ä»¬éœ€è¦å‘Šè¯‰ JavaScript å¼•æ“é€šè¿‡è°ƒç”¨å‡½æ•°æ¥æ‰§è¡Œå®ƒä»¬ã€‚å®ƒçœ‹èµ·æ¥ä¼šåƒè¿™æ ·:

```
// Define a function
function f1() {
    // Do something
    // Do something again
    // Again
    // So on...
}

// Invoke the function
f1();
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œå‡½æ•°ä¸­çš„æ¯ä¸€è¡Œéƒ½æŒ‰é¡ºåºæ‰§è¡Œï¼Œä¸€æ¬¡æ‰§è¡Œä¸€è¡Œã€‚å³ä½¿åœ¨ä»£ç ä¸­è°ƒç”¨å¤šä¸ªå‡½æ•°ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å†æ¬¡ï¼Œä¸€è¡Œä¸€è¡Œã€‚

# åŒæ­¥ JavaScriptâ€”â€”å‡½æ•°æ‰§è¡Œå †æ ˆå¦‚ä½•å·¥ä½œ

é‚£ä¹ˆå½“ä½ å®šä¹‰ä¸€ä¸ªå‡½æ•°ç„¶åè°ƒç”¨å®ƒæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼ŸJavaScript å¼•æ“ç»´æŠ¤ä¸€ä¸ªåä¸º`function execution stack`çš„`stack`æ•°æ®ç»“æ„ã€‚å †æ ˆçš„ç›®çš„æ˜¯è·Ÿè¸ªå½“å‰æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ã€‚å®ƒæ‰§è¡Œä»¥ä¸‹æ“ä½œ:

*   å½“ JavaScript å¼•æ“è°ƒç”¨ä¸€ä¸ªå‡½æ•°æ—¶ï¼Œå®ƒä¼šå°†å®ƒæ·»åŠ åˆ°å †æ ˆä¸­ï¼Œç„¶åå¼€å§‹æ‰§è¡Œã€‚
*   å¦‚æœå½“å‰æ‰§è¡Œçš„å‡½æ•°è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°ï¼Œå¼•æ“ä¼šå°†ç¬¬äºŒä¸ªå‡½æ•°æ·»åŠ åˆ°å †æ ˆä¸­ï¼Œå¹¶å¼€å§‹æ‰§è¡Œå®ƒã€‚
*   ä¸€æ—¦æ‰§è¡Œå®Œç¬¬äºŒä¸ªå‡½æ•°ï¼Œå¼•æ“å°±ä»å †æ ˆä¸­å–å‡ºå®ƒã€‚
*   æ§åˆ¶è¿”å›åˆ°ä¸Šæ¬¡ç¦»å¼€ç¬¬ä¸€ä¸ªå‡½æ•°çš„åœ°æ–¹ç»§ç»­æ‰§è¡Œã€‚
*   ä¸€æ—¦ç¬¬ä¸€ä¸ªå‡½æ•°çš„æ‰§è¡Œç»“æŸï¼Œå¼•æ“å°±å°†å®ƒä»å †æ ˆä¸­å–å‡ºã€‚
*   ç»§ç»­åŒæ ·çš„æ–¹å¼ï¼Œç›´åˆ°æ²¡æœ‰ä¸œè¥¿æ”¾å…¥å †æ ˆã€‚

å‡½æ•°æ‰§è¡Œæ ˆä¹Ÿè¢«ç§°ä¸º`Call Stack`ã€‚

![stack](img/b25600dbe04db3b4e6d4cd592d4f1e13.png)

Function Execution Stack

è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼Œä¸‰ä¸ªå‡½æ•°ä¾æ¬¡æ‰§è¡Œ:

```
function f1() {
  // some code
}
function f2() {
  // some code
}
function f3() {
  // some code
}

// Invoke the functions one by one
f1();
f2();
f3();
```

ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å‡½æ•°æ‰§è¡Œå †æ ˆä¼šå‘ç”Ÿä»€ä¹ˆ:

![first-flow](img/94784c5a9c0ded705c624ebb30d616ee.png)

A step-by-step flow shows the execution order

ä½ çœ‹åˆ°é‚£é‡Œå‘ç”Ÿäº†ä»€ä¹ˆå—ï¼Ÿé¦–å…ˆï¼Œ`f1()`è¿›å…¥å †æ ˆï¼Œæ‰§è¡Œï¼Œç„¶åå¼¹å‡ºã€‚ç„¶å`f2()`åšåŒæ ·çš„äº‹æƒ…ï¼Œæœ€å`f3()`ã€‚åœ¨é‚£ä¹‹åï¼Œå †æ ˆæ˜¯ç©ºçš„ï¼Œæ²¡æœ‰åˆ«çš„ä¸œè¥¿å¯ä»¥æ‰§è¡Œã€‚

å¥½ï¼Œç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ›´å¤æ‚çš„ä¾‹å­ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå‡½æ•°`f3()`è°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°`f2()`ï¼Œåè€…åˆè°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°`f1()`ã€‚

```
function f1() {
  // Some code
}
function f2() {
  f1();
}
function f3() {
  f2();
}
f3();
```

è®©æˆ‘ä»¬çœ‹çœ‹å‡½æ•°æ‰§è¡Œå †æ ˆæ˜¯æ€ä¹ˆå›äº‹:

![second-flow](img/a39dfc386c88af737874e173cb59f893.png)

A step-by-step flow shows the execution order

æ³¨æ„ï¼Œç¬¬ä¸€ä¸ª`f3()`è¿›å…¥å †æ ˆï¼Œè°ƒç”¨å¦ä¸€ä¸ªå‡½æ•°`f2()`ã€‚æ‰€ä»¥ç°åœ¨`f2()`è¿›å»äº†ï¼Œè€Œ`f3()`è¿˜åœ¨å †æ ˆä¸­ã€‚`f2()`åŠŸèƒ½è°ƒç”¨`f1()`ã€‚å› æ­¤ï¼Œæ˜¯æ—¶å€™è®©`f1()`è¿›å…¥å †æ ˆï¼Œè€Œ`f2()`å’Œ`f3()`éƒ½ç•™åœ¨é‡Œé¢äº†ã€‚

é¦–å…ˆï¼Œ`f1()`å®Œæˆæ‰§è¡Œå¹¶ä»å †æ ˆä¸­å‡ºæ¥ã€‚å°±åœ¨é‚£ä¸ª`f2()`ç»“æŸä¹‹åï¼Œæœ€åæ˜¯`f3()`ã€‚

åº•çº¿æ˜¯åœ¨`function execution stack`ä¸­å‘ç”Ÿçš„ä¸€åˆ‡éƒ½æ˜¯è¿ç»­çš„ã€‚è¿™æ˜¯ JavaScript çš„`Synchronous`éƒ¨åˆ†ã€‚JavaScript çš„`main`çº¿ç¨‹ç¡®ä¿å®ƒåœ¨å¼€å§‹æŸ¥çœ‹ä»»ä½•ä¸œè¥¿ä¹‹å‰å¤„ç†å¥½å †æ ˆä¸­çš„æ‰€æœ‰ä¸œè¥¿`elsewhere`ã€‚

å¤ªå¥½äº†ï¼æ—¢ç„¶æˆ‘ä»¬å·²ç»ç†è§£äº† JavaScript ä¸­çš„`synchronous`æ“ä½œæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œç°åœ¨è®©æˆ‘ä»¬æŠ›ç¡¬å¸æ¥çœ‹çœ‹å®ƒçš„`asynchronous`é¢ã€‚ä½ å‡†å¤‡å¥½äº†å—ï¼Ÿ

# å¼‚æ­¥ JavaScriptâ€”â€”æµè§ˆå™¨ API å’Œæ‰¿è¯ºå¦‚ä½•å·¥ä½œ

å•è¯`asynchronous`çš„æ„æ€æ˜¯**ä¸åŒæ—¶å‘ç”Ÿ**ã€‚åœ¨ JavaScript çš„ä¸Šä¸‹æ–‡ä¸­æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

é€šå¸¸æƒ…å†µä¸‹ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œäº‹æƒ…æ•ˆæœå¾ˆå¥½ã€‚ä½†æ˜¯æœ‰æ—¶æ‚¨å¯èƒ½éœ€è¦ä»æœåŠ¡å™¨è·å–æ•°æ®æˆ–è€…å»¶è¿Ÿæ‰§è¡Œä¸€ä¸ªå‡½æ•°ï¼Œè¿™æ˜¯æ‚¨ä¸å¸Œæœ›å‘ç”Ÿçš„äº‹æƒ…ã€‚æ‰€ä»¥ï¼Œæ‚¨å¸Œæœ›ä»£ç æ‰§è¡Œ`asynchronously`ã€‚

åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½ä¸å¸Œæœ› JavaScript å¼•æ“æš‚åœå…¶ä»–é¡ºåºä»£ç çš„æ‰§è¡Œã€‚å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒJavaScript å¼•æ“éœ€è¦æ›´æœ‰æ•ˆåœ°ç®¡ç†äº‹æƒ…ã€‚

æˆ‘ä»¬å¯ä»¥ç”¨ä¸¤ä¸ªä¸»è¦çš„è§¦å‘å™¨å¯¹å¤§å¤šæ•°å¼‚æ­¥ JavaScript æ“ä½œè¿›è¡Œåˆ†ç±»:

1.  **æµè§ˆå™¨ API/Web API** äº‹ä»¶æˆ–å‡½æ•°ã€‚è¿™äº›æ–¹æ³•åŒ…æ‹¬åƒ`setTimeout`è¿™æ ·çš„æ–¹æ³•ï¼Œæˆ–è€…åƒ clickã€mouse overã€scroll ç­‰äº‹ä»¶å¤„ç†ç¨‹åºã€‚
2.  **æ‰¿è¯º**ã€‚ä¸€ä¸ªç‹¬ç‰¹çš„ JavaScript å¯¹è±¡ï¼Œå…è®¸æˆ‘ä»¬æ‰§è¡Œå¼‚æ­¥æ“ä½œã€‚

å¦‚æœä½ ä¸ä¹ æƒ¯æ‰¿è¯ºï¼Œä¸è¦æ‹…å¿ƒã€‚è¦é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Œä½ ä¸éœ€è¦çŸ¥é“æ›´å¤šã€‚åœ¨æ–‡ç« çš„æœ€åï¼Œæˆ‘æä¾›äº†ä¸€äº›é“¾æ¥ï¼Œè¿™æ ·ä½ å°±å¯ä»¥ç”¨å¯¹åˆå­¦è€…æœ€å‹å¥½çš„æ–¹å¼å¼€å§‹å­¦ä¹ æ‰¿è¯ºã€‚

## å¦‚ä½•å¤„ç†æµè§ˆå™¨ API/Web API

åƒ`setTimeout`å’Œäº‹ä»¶å¤„ç†ç¨‹åºè¿™æ ·çš„æµè§ˆå™¨ API ä¾èµ–äº`callback`å‡½æ•°ã€‚å½“å¼‚æ­¥æ“ä½œå®Œæˆæ—¶ï¼Œå›è°ƒå‡½æ•°æ‰§è¡Œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå…³äº`setTimeout`å‡½æ•°å¦‚ä½•å·¥ä½œçš„ä¾‹å­:

```
function printMe() {
  console.log('print me');
}

setTimeout(printMe, 2000);
```

`setTimeout`åŠŸèƒ½åœ¨ç»è¿‡ä¸€å®šæ—¶é—´åæ‰§è¡ŒåŠŸèƒ½ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæ–‡æœ¬`print me`åœ¨å»¶è¿Ÿ 2 ç§’åç™»å½•åˆ°æ§åˆ¶å°ã€‚

ç°åœ¨å‡è®¾æˆ‘ä»¬åœ¨`setTimeout`å‡½æ•°ä¹‹åè¿˜æœ‰å‡ è¡Œä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```
function printMe() {
  console.log('print me');
}

function test() {
  console.log('test');
}

setTimeout(printMe, 2000);
test(); 
```

é‚£ä¹ˆï¼Œæˆ‘ä»¬æœŸæœ›è¿™é‡Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿä½ è®¤ä¸ºè¾“å‡ºä¼šæ˜¯ä»€ä¹ˆï¼Ÿ

JavaScript å¼•æ“æ˜¯å¦ä¼šç­‰å¾… 2 ç§’é’Ÿæ¥è°ƒç”¨`test()`å‡½æ•°å¹¶è¾“å‡º:

```
printMe
test
```

æˆ–è€…å®ƒä¼šè®¾æ³•æŠŠ`setTimeout`çš„å›è°ƒå‡½æ•°æ”¾åœ¨ä¸€è¾¹ï¼Œç»§ç»­å®ƒçš„å…¶ä»–æ‰§è¡Œå—ï¼Ÿå› æ­¤ï¼Œè¾“å‡ºå¯èƒ½æ˜¯è¿™æ ·çš„:

```
test
printMe
```

å¦‚æœä½ çŒœçš„æ˜¯åè€…ï¼Œé‚£ä½ å°±å¯¹äº†ã€‚è¿™å°±æ˜¯å¼‚æ­¥æœºåˆ¶å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚

## JavaScript å›è°ƒé˜Ÿåˆ—å¦‚ä½•å·¥ä½œ(ä¹Ÿç§°ä¸ºä»»åŠ¡é˜Ÿåˆ—)

JavaScript ç»´æŠ¤ä¸€ä¸ªå›è°ƒå‡½æ•°é˜Ÿåˆ—ã€‚å®ƒè¢«ç§°ä¸ºå›è°ƒé˜Ÿåˆ—æˆ–ä»»åŠ¡é˜Ÿåˆ—ã€‚ä¸€ä¸ªé˜Ÿåˆ—æ•°æ®ç»“æ„æ˜¯`First-In-First-Out(FIFO)`ã€‚æ‰€ä»¥ï¼Œé¦–å…ˆè¿›å…¥é˜Ÿåˆ—çš„å›è°ƒå‡½æ•°æœ‰æœºä¼šå…ˆå‡ºå»ã€‚ä½†é—®é¢˜æ˜¯:

*   JavaScript å¼•æ“ä»€ä¹ˆæ—¶å€™æŠŠå®ƒæ”¾å…¥é˜Ÿåˆ—ï¼Ÿ
*   JavaScript å¼•æ“ä»€ä¹ˆæ—¶å€™å°†å®ƒä»é˜Ÿåˆ—ä¸­å–å‡ºï¼Ÿ
*   å®ƒä»é˜Ÿåˆ—ä¸­å‡ºæ¥åå»äº†å“ªé‡Œï¼Ÿ
*   æœ€é‡è¦çš„æ˜¯ï¼Œæ‰€æœ‰è¿™äº›ä¸ JavaScript çš„å¼‚æ­¥éƒ¨åˆ†æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

å“‡ï¼Œå¥½å¤šé—®é¢˜ï¼è®©æˆ‘ä»¬åœ¨ä¸‹å›¾çš„å¸®åŠ©ä¸‹æ‰¾å‡ºç­”æ¡ˆ:

![taskQ](img/2025f8afca92b3a11e8b0f0b11807080.png)

ä¸Šå›¾æ˜¾ç¤ºçš„æ˜¯æˆ‘ä»¬å·²ç»è§è¿‡çš„å¸¸è§„`call stack`ã€‚å¦‚æœæµè§ˆå™¨ API(å¦‚ setTimeout)å¯åŠ¨å¹¶ä»è¯¥ API è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œéœ€è¦è·Ÿè¸ªå¦å¤–ä¸¤ä¸ªéƒ¨åˆ†ã€‚

JavaScript å¼•æ“ç»§ç»­æ‰§è¡Œè°ƒç”¨å †æ ˆä¸­çš„å‡½æ•°ã€‚å› ä¸ºå®ƒæ²¡æœ‰å°†å›è°ƒå‡½æ•°ç›´æ¥æ”¾å…¥å †æ ˆï¼Œæ‰€ä»¥ä¸å­˜åœ¨ä»»ä½•ä»£ç åœ¨å †æ ˆä¸­ç­‰å¾…/é˜»å¡æ‰§è¡Œçš„é—®é¢˜ã€‚

å¼•æ“åˆ›å»ºä¸€ä¸ª`loop`æ¥å‘¨æœŸæ€§åœ°æŸ¥çœ‹é˜Ÿåˆ—ï¼Œä»¥æ‰¾åˆ°å®ƒéœ€è¦ä»é‚£é‡Œè·å–çš„å†…å®¹ã€‚å½“å †æ ˆä¸ºç©ºæ—¶ï¼Œå®ƒä»é˜Ÿåˆ—ä¸­æå–ä¸€ä¸ªå›è°ƒå‡½æ•°åˆ°è°ƒç”¨å †æ ˆä¸­ã€‚ç°åœ¨å›è°ƒå‡½æ•°é€šå¸¸åƒå †æ ˆä¸­çš„å…¶ä»–å‡½æ•°ä¸€æ ·æ‰§è¡Œã€‚å¾ªç¯ç»§ç»­ã€‚è¿™ä¸ªå¾ªç¯ä»¥`Event Loop`è€Œé—»åã€‚

æ‰€ä»¥ï¼Œè¿™ä¸ªæ•…äº‹çš„å¯“æ„æ˜¯:

*   å½“æµè§ˆå™¨ API å‡ºç°æ—¶ï¼Œå°†å›è°ƒå‡½æ•°æ”¾åœ¨é˜Ÿåˆ—ä¸­ã€‚
*   åœ¨å †æ ˆä¸­ç…§å¸¸æ‰§è¡Œä»£ç ã€‚
*   äº‹ä»¶å¾ªç¯æ£€æŸ¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å›è°ƒå‡½æ•°ã€‚
*   å¦‚æœæ˜¯è¿™æ ·ï¼Œå°†å›è°ƒå‡½æ•°ä»é˜Ÿåˆ—ä¸­æ‹‰åˆ°å †æ ˆä¸­å¹¶æ‰§è¡Œã€‚
*   ç»§ç»­å¾ªç¯ã€‚

å¥½äº†ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¸‹é¢çš„ä»£ç æ˜¯å¦‚ä½•å·¥ä½œçš„:

```
function f1() {
    console.log('f1');
}

function f2() {
    console.log('f2');
}

function main() {
    console.log('main');

    setTimeout(f1, 0);

    f2();
}

main();
```

ä»£ç æ‰§è¡Œä¸€ä¸ªå¸¦æœ‰å›è°ƒå‡½æ•°`f1()`çš„`setTimeout`å‡½æ•°ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ²¡æœ‰ç»™å®ƒä»»ä½•å»¶è¿Ÿã€‚è¿™æ„å‘³ç€æˆ‘ä»¬æœŸæœ›å‡½æ•°`f1()`ç«‹å³æ‰§è¡Œã€‚åœ¨ setTimeout ä¹‹åï¼Œæˆ‘ä»¬æ‰§è¡Œå¦ä¸€ä¸ªå‡½æ•°`f2()`ã€‚

é‚£ä¹ˆï¼Œä½ è®¤ä¸ºè¾“å‡ºä¼šæ˜¯ä»€ä¹ˆï¼Ÿè¿™æ˜¯:

```
main
f2
f1
```

ä½†æ˜¯ï¼Œæ‚¨å¯èƒ½è®¤ä¸º`f1`åº”è¯¥åœ¨`f2`ä¹‹å‰æ‰“å°ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰å»¶è¿Ÿ f1 çš„æ‰§è¡Œã€‚ä½†ä¸ï¼Œäº‹å®å¹¶éå¦‚æ­¤ã€‚è¿˜è®°å¾—æˆ‘ä»¬ä¸Šé¢è®¨è®ºçš„`event loop`æœºåˆ¶å—ï¼Ÿç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸Šé¢ä»£ç çš„ä¸€æ­¥ä¸€æ­¥çš„æµç¨‹ã€‚

![third-flow](img/45d349c86e38ed6ce00ca0a0fe696ca7.png)

Event loop - see the step-by-step execution

ä»¥ä¸‹æ˜¯å†™å‡ºæ¥çš„æ­¥éª¤:

1.  `main()`å‡½æ•°è¿›å…¥è°ƒç”¨å †æ ˆã€‚
2.  å®ƒæœ‰ä¸€ä¸ªæ§åˆ¶å°æ—¥å¿—æ¥æ‰“å°å•è¯ mainã€‚`console.log('main')`æ‰§è¡Œå¹¶é€€å‡ºå †æ ˆã€‚
3.  å‘ç”Ÿ setTimeout æµè§ˆå™¨ APIã€‚
4.  å›è°ƒå‡½æ•°å°†å®ƒæ”¾å…¥å›è°ƒé˜Ÿåˆ—ã€‚
5.  åœ¨å †æ ˆä¸­ï¼Œæ‰§è¡Œç…§å¸¸å‘ç”Ÿï¼Œæ‰€ä»¥`f2()`è¿›å…¥å †æ ˆã€‚æ‰§è¡Œ`f2()`çš„æ§åˆ¶å°æ—¥å¿—ã€‚ä¸¤è€…éƒ½ä»å †æ ˆä¸­åˆ é™¤ã€‚
6.  `main()`ä¹Ÿä»å †æ ˆä¸­å¼¹å‡ºã€‚
7.  äº‹ä»¶å¾ªç¯è¯†åˆ«å‡ºè°ƒç”¨å †æ ˆæ˜¯ç©ºçš„ï¼Œå¹¶ä¸”é˜Ÿåˆ—ä¸­æœ‰ä¸€ä¸ªå›è°ƒå‡½æ•°ã€‚
8.  å›è°ƒå‡½æ•°`f1()`ç„¶åè¿›å…¥å †æ ˆã€‚å¼€å§‹æ‰§è¡Œã€‚æ§åˆ¶å°æ—¥å¿—æ‰§è¡Œï¼Œ`f1()`ä¹Ÿä»å †æ ˆä¸­å‡ºæ¥ã€‚
9.  æ­¤æ—¶ï¼Œå †æ ˆå’Œé˜Ÿåˆ—ä¸­æ²¡æœ‰å…¶ä»–ä¸œè¥¿å¯ä»¥è¿›ä¸€æ­¥æ‰§è¡Œã€‚

æˆ‘å¸Œæœ›ç°åœ¨ä½ å·²ç»æ¸…æ¥š JavaScript çš„`asynchronous`éƒ¨åˆ†æ˜¯å¦‚ä½•åœ¨å†…éƒ¨å·¥ä½œçš„äº†ã€‚ä½†æ˜¯ï¼Œè¿™è¿˜ä¸æ˜¯å…¨éƒ¨ã€‚æˆ‘ä»¬è¿˜è¦çœ‹`promises`ã€‚

## JavaScript å¼•æ“å¦‚ä½•å¤„ç†æ‰¿è¯º

åœ¨ JavaScript ä¸­ï¼Œæ‰¿è¯ºæ˜¯å¸®åŠ©æ‚¨æ‰§è¡Œå¼‚æ­¥æ“ä½œçš„ç‰¹æ®Šå¯¹è±¡ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨`Promise`æ„é€ å‡½æ•°åˆ›å»ºä¸€ä¸ªæ‰¿è¯ºã€‚æ‚¨éœ€è¦å‘å®ƒä¼ é€’ä¸€ä¸ª`executor`å‡½æ•°ã€‚åœ¨ executor å‡½æ•°ä¸­ï¼Œæ‚¨å®šä¹‰äº†å½“ä¸€ä¸ªæ‰¿è¯ºæˆåŠŸè¿”å›æˆ–æŠ›å‡ºé”™è¯¯æ—¶æ‚¨æƒ³è¦åšä»€ä¹ˆã€‚ä½ å¯ä»¥é€šè¿‡åˆ†åˆ«è°ƒç”¨`resolve`å’Œ`reject`æ–¹æ³•æ¥å®ç°ã€‚

ä»¥ä¸‹æ˜¯ JavaScript ä¸­çš„ä¸€ä¸ªæ‰¿è¯ºç¤ºä¾‹:

```
const promise = new Promise((resolve, reject) =>
        resolve('I am a resolved promise');
);
```

åœ¨æ‰§è¡Œæ‰¿è¯ºä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`.then()`æ–¹æ³•å¤„ç†ç»“æœï¼Œä½¿ç”¨`.catch()`æ–¹æ³•å¤„ç†ä»»ä½•é”™è¯¯ã€‚

```
promise.then(result => console.log(result))
```

æ¯æ¬¡ä½¿ç”¨`fetch()`æ–¹æ³•ä»å•†åº—è·å–æ•°æ®æ—¶ï¼Œæ‚¨éƒ½ä½¿ç”¨äº† promisesã€‚

è¿™é‡Œçš„è¦ç‚¹æ˜¯ JavaScript å¼•æ“ä¸ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„æµè§ˆå™¨ API çš„`callback queue`ã€‚å®ƒä½¿ç”¨å¦ä¸€ä¸ªç§°ä¸º`Job Queue`çš„ç‰¹æ®Šé˜Ÿåˆ—ã€‚

## JavaScript ä¸­çš„ä½œä¸šé˜Ÿåˆ—æ˜¯ä»€ä¹ˆï¼Ÿ

æ¯å½“ä»£ç ä¸­å‡ºç°ä¸€ä¸ªæ‰¿è¯ºï¼Œexecutor å‡½æ•°å°±ä¼šè¿›å…¥ä½œä¸šé˜Ÿåˆ—ã€‚äº‹ä»¶å¾ªç¯ç…§å¸¸å·¥ä½œï¼ŒæŸ¥çœ‹é˜Ÿåˆ—ï¼Œä½†æ˜¯å½“`stack`ç©ºé—²æ—¶ï¼Œç»™äºˆ`job queue`é¡¹ä¼˜å…ˆäº`callback queue`é¡¹çš„ä¼˜å…ˆæƒã€‚

å›è°ƒé˜Ÿåˆ—ä¸­çš„é¡¹ç›®ç§°ä¸º`macro task`ï¼Œè€Œä½œä¸šé˜Ÿåˆ—ä¸­çš„é¡¹ç›®ç§°ä¸º`micro task`ã€‚

æ‰€ä»¥æ•´ä¸ªæµç¨‹æ˜¯è¿™æ ·çš„:

*   å¯¹äº`event loop`çš„æ¯ä¸ªå¾ªç¯ï¼Œå®Œæˆ`callback queue`ä¸­çš„ä¸€ä¸ªä»»åŠ¡ã€‚
*   ä¸€æ—¦ä»»åŠ¡å®Œæˆï¼Œäº‹ä»¶å¾ªç¯è®¿é—®`job queue`ã€‚å®ƒå®Œæˆäº†ä½œä¸šé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰`micro tasks`,ç„¶åå¼€å§‹ä¸‹ä¸€æ­¥å·¥ä½œã€‚
*   å¦‚æœä¸¤ä¸ªé˜Ÿåˆ—åœ¨ç›¸åŒçš„æ—¶é—´ç‚¹è·å¾—æ¡ç›®ï¼Œ`job queue`æ¯”`callback queue`è·å¾—ä¼˜å…ˆæƒã€‚

ä¸‹å›¾æ˜¾ç¤ºäº†åŒ…å«çš„ä½œä¸šé˜Ÿåˆ—ä»¥åŠå…¶ä»–é¢„å…ˆå­˜åœ¨çš„é¡¹ç›®ã€‚

![JObQ](img/39971be4dd84056793dcab61ff30c664.png)

ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­æ¥æ›´å¥½åœ°ç†è§£è¿™ä¸ªåºåˆ—:

```
function f1() {
    console.log('f1');
}

function f2() {
    console.log('f2');
}

function main() {
    console.log('main');

    setTimeout(f1, 0);

    new Promise((resolve, reject) =>
        resolve('I am a promise')
    ).then(resolve => console.log(resolve))

    f2();
}

main();
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åƒä»¥å‰ä¸€æ ·æœ‰ä¸€ä¸ª`setTimeout()`å‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å®ƒåé¢å¼•å…¥äº†ä¸€ä¸ªæ‰¿è¯ºã€‚ç°åœ¨è®°ä½æˆ‘ä»¬å­¦è¿‡çš„æ‰€æœ‰å†…å®¹ï¼Œå¹¶çŒœæµ‹è¾“å‡ºã€‚

å¦‚æœæ‚¨çš„ç­”æ¡ˆä¸æ­¤ç›¸ç¬¦ï¼Œåˆ™æ‚¨ç­”å¯¹äº†:

```
main
f2
I am a promise
f1
```

ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹åŠ¨ä½œçš„æµç¨‹:

![fourth-flow](img/4c9a57962d735a2089245daab61871f4.png)

Callback queue vs. Job queue

æµç¨‹ä¸ä¸Šé¢çš„å‡ ä¹ç›¸åŒï¼Œä½†æ˜¯æ³¨æ„ä½œä¸šé˜Ÿåˆ—ä¸­çš„é¡¹ç›®å¦‚ä½•ä¼˜å…ˆäºä»»åŠ¡é˜Ÿåˆ—ä¸­çš„é¡¹ç›®æ˜¯è‡³å…³é‡è¦çš„ã€‚è¿˜è¦æ³¨æ„ï¼Œå³ä½¿`setTimeout`æ²¡æœ‰å»¶è¿Ÿä¹Ÿæ²¡æœ‰å…³ç³»ã€‚å®ƒæ€»æ˜¯å…³äºåœ¨å›è°ƒé˜Ÿåˆ—ä¹‹å‰çš„ä½œä¸šé˜Ÿåˆ—ã€‚

å¥½äº†ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†ç†è§£ JavaScript ä¸­åŒæ­¥å’Œå¼‚æ­¥æ‰§è¡Œæ‰€éœ€çš„ä¸€åˆ‡ã€‚

# è¿™æ˜¯ç»™ä½ çš„ä¸€ä¸ªæµ‹éªŒï¼

è®©æˆ‘ä»¬åšä¸ªå°æµ‹éªŒæ¥æµ‹è¯•ä¸€ä¸‹ä½ çš„ç†è§£ç¨‹åº¦ã€‚çŒœæµ‹ä»¥ä¸‹ä»£ç çš„è¾“å‡ºï¼Œå¹¶åº”ç”¨åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬è·å¾—çš„æ‰€æœ‰çŸ¥è¯†:

```
function f1() {
 console.log('f1');
}

function f2() { 
    console.log('f2');
}

function f3() { 
    console.log('f3');
}

function main() {
  console.log('main');

  setTimeout(f1, 50);
  setTimeout(f3, 30);

  new Promise((resolve, reject) =>
    resolve('I am a Promise, right after f1 and f3! Really?')
  ).then(resolve => console.log(resolve));

  new Promise((resolve, reject) =>
    resolve('I am a Promise after Promise!')
  ).then(resolve => console.log(resolve));

  f2();
}

main();
```

ä»¥ä¸‹æ˜¯é¢„æœŸçš„è¾“å‡º:

```
main
f2
I am a Promise, right after f1 and f3! Really?
I am a Promise after Promise!
f3
f1
```

ä½ æƒ³è¦æ›´å¤šè¿™æ ·çš„æµ‹éªŒå—ï¼Ÿå‰å¾€è¯¥ä»“åº“è¿›è¡Œæ›´å¤šç»ƒä¹ ã€‚

å¦‚æœä½ è¢«å¡ä½æˆ–éœ€è¦ä»»ä½•æ¾„æ¸…ï¼Œæˆ‘çš„ DM æ€»æ˜¯åœ¨ Twitter ä¸Šæ‰“å¼€[ã€‚](https://twitter.com/tapasadhikary)

# æ¦‚æ‹¬èµ·æ¥

æ€»ç»“ä¸€ä¸‹:

*   JavaScript å¼•æ“ä½¿ç”¨å †æ ˆæ•°æ®ç»“æ„æ¥è·Ÿè¸ªå½“å‰æ‰§è¡Œçš„å‡½æ•°ã€‚è¿™ä¸ªå †æ ˆè¢«ç§°ä¸ºå‡½æ•°æ‰§è¡Œå †æ ˆã€‚
*   å‡½æ•°æ‰§è¡Œå †æ ˆ(ä¹Ÿç§°ä¸ºè°ƒç”¨å †æ ˆ)ä¸€è¡Œä¸€è¡Œã€ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°é¡ºåºæ‰§è¡Œå‡½æ•°ã€‚
*   å½“å¼‚æ­¥æ“ä½œ/å»¶è¿Ÿå®Œæˆæ—¶ï¼Œæµè§ˆå™¨/web API ä½¿ç”¨å›è°ƒå‡½æ•°æ¥å®Œæˆä»»åŠ¡ã€‚å›è°ƒå‡½æ•°è¢«æ”¾åœ¨å›è°ƒé˜Ÿåˆ—ä¸­ã€‚
*   promise executor å‡½æ•°æ”¾åœ¨ä½œä¸šé˜Ÿåˆ—ä¸­ã€‚
*   å¯¹äºäº‹ä»¶å¾ªç¯çš„æ¯ä¸ªå¾ªç¯ï¼Œåœ¨å›è°ƒé˜Ÿåˆ—ä¹‹å¤–å®Œæˆä¸€ä¸ªå®ä»»åŠ¡ã€‚
*   ä¸€æ—¦ä»»åŠ¡å®Œæˆï¼Œäº‹ä»¶å¾ªç¯è®¿é—®ä½œä¸šé˜Ÿåˆ—ã€‚å®ƒåœ¨å¯»æ‰¾ä¸‹ä¸€ä»¶äº‹æƒ…ä¹‹å‰å®Œæˆä½œä¸šé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡ã€‚
*   å¦‚æœä¸¤ä¸ªé˜Ÿåˆ—åœ¨åŒä¸€æ—¶é—´ç‚¹è·å¾—æ¡ç›®ï¼Œåˆ™ä½œä¸šé˜Ÿåˆ—ä¼˜å…ˆäºå›è°ƒé˜Ÿåˆ—ã€‚

# åœ¨ç»“æŸä¹‹å‰...

ç›®å‰å°±è¿™äº›ã€‚æˆ‘å¸Œæœ›æ‚¨è§‰å¾—è¿™ç¯‡æ–‡ç« å¾ˆæœ‰è§åœ°ï¼Œå¹¶ä¸”æœ‰åŠ©äºæ‚¨æ›´å¥½åœ°ç†è§£ JavaScript çš„åŒæ­¥å’Œå¼‚æ­¥æ¦‚å¿µã€‚

æˆ‘ä»¬æ¥è¿çº¿ã€‚ä½ å¯ä»¥åœ¨ [Twitter(@tapasadhikary)](https://twitter.com/tapasadhikary) ã€æˆ‘çš„ [Youtube é¢‘é“](https://youtube.com/c/TapasAdhikary?sub_confirmation=1)ã€ä»¥åŠ [GitHub(atapas)](https://github.com/atapas) ä¸Šå…³æ³¨æˆ‘ã€‚

å¦‚å‰æ‰€è¿°ï¼Œè¿™é‡Œæœ‰å‡ ç¯‡æ–‡ç« ä½ å¯èƒ½ä¼šè§‰å¾—æœ‰ç”¨ï¼Œ

*   [JavaScript æ‰¿è¯ºâ€”â€”è§£é‡Šå¾—åƒæˆ‘äº”å²ä¸€æ ·](https://blog.greenroots.info/javascript-promises-explain-like-i-am-five)
*   [JavaScript æ‰¿è¯ºé“¾â€”â€”å¤„ç†æ‰¿è¯ºçš„è‰ºæœ¯](https://blog.greenroots.info/javascript-promise-chain-the-art-of-handling-promises)
*   [JavaScript async å’Œ await -è¯·ç”¨ç®€å•çš„è‹±è¯­](https://blog.greenroots.info/javascript-async-and-await-in-plain-english-please)
*   [ä»‹ç» PromiViz -å¯è§†åŒ–å¹¶å­¦ä¹  JavaScript promise API](https://blog.greenroots.info/introducing-promiviz-visualize-and-learn-javascript-promise-apis)