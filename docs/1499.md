# react . use effect Hookâ€“å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ³•

> åŸæ–‡ï¼š<https://www.freecodecamp.org/news/most-common-react-useeffect-problems-and-how-to-fix-them/>

React hooks å·²ç»å­˜åœ¨äº†ä¸€æ®µæ—¶é—´äº†ã€‚å¤§å¤šæ•°å¼€å‘äººå‘˜å·²ç»å¯¹ä»–ä»¬çš„å·¥ä½œæ–¹å¼å’Œå¸¸è§ç”¨ä¾‹ç›¸å½“ç†Ÿæ‚‰äº†ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯æˆ‘ä»¬å¾ˆå¤šäººç»å¸¸ä¼šä¸Šå½“çš„ã€‚

# ä½¿ç”¨æ¡ˆä¾‹

è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„åœºæ™¯å¼€å§‹ã€‚æˆ‘ä»¬æ­£åœ¨æ„å»ºä¸€ä¸ª React åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æˆ‘ä»¬çš„ä¸€ä¸ªç»„ä»¶ä¸­æ˜¾ç¤ºå½“å‰ç”¨æˆ·çš„ç”¨æˆ·åã€‚ä½†æ˜¯é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä» API è·å–ç”¨æˆ·åã€‚

å› ä¸ºæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬è¿˜éœ€è¦åœ¨åº”ç”¨ç¨‹åºçš„å…¶ä»–åœ°æ–¹ä½¿ç”¨ç”¨æˆ·æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æƒ³åœ¨è‡ªå®šä¹‰çš„ React é’©å­ä¸­æŠ½è±¡æ•°æ®æå–é€»è¾‘ã€‚

æœ¬è´¨ä¸Šï¼Œæˆ‘ä»¬å¸Œæœ› React ç»„ä»¶çœ‹èµ·æ¥åƒè¿™æ ·:

```
const Component = () => {
  // useUser custom hook

  return <div>{user.name}</div>;
}; 
```

çœ‹èµ·æ¥å¤Ÿç®€å•ï¼

# ç”¨æˆ·ç”¨æˆ·ååº”æŒ‚é’©

ç¬¬äºŒæ­¥æ˜¯åˆ›å»ºæˆ‘ä»¬çš„`useUser`å®šåˆ¶é’©å­ã€‚

```
const useUser = (user) => {
  const [userData, setUserData] = useState();
  useEffect(() => {
    if (user) {
      fetch("users.json").then((response) =>
        response.json().then((users) => {
          return setUserData(users.find((item) => item.id === user.id));
        })
      );
    }
  }, []);

  return userData;
}; 
```

æˆ‘ä»¬æ¥åˆ†è§£ä¸€ä¸‹ã€‚æˆ‘ä»¬æ­£åœ¨æ£€æŸ¥é’©å­æ˜¯å¦æ­£åœ¨æ¥æ”¶ä¸€ä¸ªç”¨æˆ·å¯¹è±¡ã€‚ä¹‹åï¼Œæˆ‘ä»¬ä»ä¸€ä¸ªåä¸º`users.json`çš„æ–‡ä»¶ä¸­è·å–ä¸€ä¸ªç”¨æˆ·åˆ—è¡¨ï¼Œå¹¶å¯¹å…¶è¿›è¡Œè¿‡æ»¤ï¼Œä»¥ä¾¿æ‰¾åˆ°å…·æœ‰æˆ‘ä»¬éœ€è¦çš„ id çš„ç”¨æˆ·ã€‚

ç„¶åï¼Œä¸€æ—¦æˆ‘ä»¬æœ‰äº†å¿…è¦çš„æ•°æ®ï¼Œæˆ‘ä»¬å°±æŠŠå®ƒä¿å­˜åˆ°é’©å­çš„`userData`çŠ¶æ€ã€‚æœ€åéƒ½æ˜¯è¿”å›`userData`ã€‚

***æ³¨**:è¿™æ˜¯ä¸€ä¸ªäººä¸ºçš„ä¾‹å­ï¼Œä»…ä¾›è¯´æ˜ä¹‹ç”¨ï¼ç°å®ä¸–ç•Œä¸­çš„æ•°æ®è·å–è¦å¤æ‚å¾—å¤šã€‚å¦‚æœä½ å¯¹è¿™ä¸ªè¯é¢˜æ„Ÿå…´è¶£ï¼Œ[å¯ä»¥çœ‹çœ‹æˆ‘çš„æ–‡ç« ](https://blog.whereisthemouse.com/graphql-requests-made-easy-with-react-query-and-typescript)å…³äºå¦‚ä½•ç”¨ ReactQueryã€Typescript å’Œ GraphQL åˆ›å»ºä¸€ä¸ªä¼Ÿå¤§çš„æ•°æ®è·å–è®¾ç½®ã€‚*

è®©æˆ‘ä»¬å°†é’©å­æ’å…¥ React ç»„ä»¶ï¼Œçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚

```
const Component = () => {
  const user = useUser({ id: 1 });
  return <div>{user?.name}</div>;
}; 
```

ä¸é”™ï¼ä¸€åˆ‡çœ‹èµ·æ¥å’Œå·¥ä½œèµ·æ¥éƒ½åƒé¢„æœŸçš„é‚£æ ·ã€‚ä½†æ˜¯ç­‰ç­‰...è¿™æ˜¯ä»€ä¹ˆï¼Ÿ

# åŸƒæ–¯æ—ç‰¹ç©·å°½-å¾·æ™®æ–¯è§„åˆ™

æˆ‘ä»¬çš„é’©å­ä¸­æœ‰ä¸€ä¸ª ESLint è­¦å‘Š:

```
React Hook useEffect has a missing dependency: 'user'. Either include it or remove the dependency array. (react-hooks/exhaustive-deps) 
```

å—¯ï¼Œæˆ‘ä»¬çš„`useEffect`å¥½åƒå°‘äº†ä¸€ä¸ªä¾èµ–ã€‚å“¦ï¼Œå¥½å§ï¼è¡¥å……ä¸€ä¸‹å§ã€‚æœ€åèƒ½å‘ç”Ÿä»€ä¹ˆï¼ŸğŸ˜‚

```
const useUser = (user) => {
  const [userData, setUserData] = useState();
  useEffect(() => {
    if (user) {
      fetch("users.json").then((response) =>
        response.json().then((users) => {
          return setUserData(users.find((item) => item.id === user.id));
        })
      );
    }
  }, [user]);

  return userData;
}; 
```

å•Šå“¦ï¼çœ‹èµ·æ¥æˆ‘ä»¬çš„`Component`ç°åœ¨ä¸ä¼šåœæ­¢é‡æ–°æ¸²æŸ“ã€‚è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿï¼

æˆ‘ä»¬æ¥è§£é‡Šä¸€ä¸‹ã€‚

# æ— é™å†ç°é—®é¢˜

æˆ‘ä»¬çš„ç»„ä»¶è¢«é‡æ–°æ¸²æŸ“çš„åŸå› æ˜¯å› ä¸ºæˆ‘ä»¬çš„`useEffect`ä¾èµ–å…³ç³»åœ¨ä¸æ–­å˜åŒ–ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬æ€»æ˜¯å°†åŒä¸€ä¸ªå¯¹è±¡ä¼ é€’ç»™æˆ‘ä»¬çš„é’©å­ï¼

è™½ç„¶æˆ‘ä»¬ç¡®å®ä¼ é€’äº†ä¸€ä¸ªå…·æœ‰ç›¸åŒé”®å’Œå€¼çš„å¯¹è±¡ï¼Œä½†å®ƒå¹¶ä¸æ˜¯å®Œå…¨ç›¸åŒçš„å¯¹è±¡ã€‚æ¯æ¬¡æˆ‘ä»¬é‡æ–°æ¸²æŸ“æˆ‘ä»¬çš„`Component`ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯åœ¨åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚ç„¶åæˆ‘ä»¬å°†æ–°å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ é€’ç»™æˆ‘ä»¬çš„`useUser`é’©å­ã€‚

åœ¨å†…éƒ¨ï¼Œ`useEffect`æ¯”è¾ƒè¿™ä¸¤ä¸ªå¯¹è±¡ï¼Œç”±äºå®ƒä»¬æœ‰ä¸åŒçš„å¼•ç”¨ï¼Œå®ƒå†æ¬¡è·å–ç”¨æˆ·å¹¶å°†æ–°çš„ç”¨æˆ·å¯¹è±¡è®¾ç½®ä¸ºçŠ¶æ€ã€‚çŠ¶æ€æ›´æ–°ç„¶åè§¦å‘ç»„ä»¶ä¸­çš„é‡æ–°å‘ˆç°ã€‚ç­‰ç­‰ï¼Œç­‰ç­‰ï¼Œç­‰ç­‰...

é‚£ä¹ˆæˆ‘ä»¬èƒ½åšä»€ä¹ˆå‘¢ï¼Ÿ

# æ€ä¹ˆä¿®

æ—¢ç„¶æˆ‘ä»¬ç†è§£äº†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å¯»æ‰¾è§£å†³åŠæ³•äº†ã€‚

ç¬¬ä¸€ä¸ªä¹Ÿå¯èƒ½æ˜¯æœ€æ˜æ˜¾çš„é€‰æ‹©æ˜¯ä»`useEffect`ä¾èµ–æ•°ç»„ä¸­ç§»é™¤ä¾èµ–ï¼Œå¿½ç•¥ ESLint è§„åˆ™ï¼Œç»§ç»­æˆ‘ä»¬çš„ç”Ÿæ´»ã€‚

ä½†è¿™æ˜¯é”™è¯¯çš„æ–¹æ³•ã€‚è¿™å¯èƒ½(å¾ˆå¯èƒ½)ä¼šå¯¼è‡´æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå‡ºç°é”™è¯¯å’Œæ„å¤–è¡Œä¸ºã€‚å¦‚æœä½ æƒ³äº†è§£æ›´å¤šå…³äº`useEffect`çš„å·¥ä½œåŸç†ï¼Œæˆ‘å¼ºçƒˆæ¨èä¸¹Â·é˜¿å¸ƒæ‹‰è«å¤«çš„[å®Œå…¨æŒ‡å—](https://overreacted.io/a-complete-guide-to-useeffect/)ã€‚

é‚£ä¹ˆä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆï¼Ÿ

åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯ä»ç»„ä»¶ä¸­å–å‡º`{ id: 1 }`å¯¹è±¡ã€‚è¿™æ ·ä¼šç»™å¯¹è±¡ä¸€ä¸ªç¨³å®šçš„å‚è€ƒï¼Œè§£å†³æˆ‘ä»¬çš„é—®é¢˜ã€‚

```
const userObject = { id: 1 };

const Component = () => {
  const user = useUser(userObject);
  return <div>{user?.name}</div>;
};

export default Component; 
```

ä½†è¿™å¹¶ä¸æ€»æ˜¯å¯èƒ½çš„ã€‚å‡è®¾ç”¨æˆ· id åœ¨æŸç§ç¨‹åº¦ä¸Šä¾èµ–äºç»„ä»¶å±æ€§æˆ–çŠ¶æ€ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯èƒ½ä½¿ç”¨ URL å‚æ•°æ¥è®¿é—®å®ƒã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ–¹ä¾¿çš„`useMemo`é’©å­æ¥è®°å¿†å¯¹è±¡å¹¶å†æ¬¡ç¡®ä¿ä¸€ä¸ªç¨³å®šçš„å¼•ç”¨ã€‚

```
const Component = () => {
  const { userId } = useParams();

  const userObject = useMemo(() => {
    return { id: userId };
  }, [userId]); // Don't forget the dependencies here either!

  const user = useUser(userObject);
  return <div>{user?.name}</div>;
};

export default Component; 
```

æœ€åï¼Œå¯ä»¥åªä¼ é€’ç”¨æˆ· id æœ¬èº«ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸå§‹å€¼ï¼Œè€Œä¸æ˜¯å°†å¯¹è±¡å˜é‡ä¼ é€’ç»™æˆ‘ä»¬çš„`useUser`é’©å­ã€‚è¿™å°†é˜²æ­¢`useEffect`é’©å­ä¸­çš„å¼•ç”¨ç›¸ç­‰é—®é¢˜ã€‚

```
const useUser = (userId) => {
  const [userData, setUserData] = useState();

  useEffect(() => {
    fetch("users.json").then((response) =>
      response.json().then((users) => {
        return setUserData(users.find((item) => item.id === userId));
      })
    );
  }, [userId]);

  return userData;
};

const Component = () => {
  const user = useUser(1);

  return <div>{user?.name}</div>;
}; 
```

é—®é¢˜è§£å†³äº†ï¼

åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç”šè‡³ä¸éœ€è¦è¿åä»»ä½• ESLint è§„åˆ™...

***æ³¨æ„:**å¦‚æœæˆ‘ä»¬ä¼ é€’ç»™è‡ªå®šä¹‰é’©å­çš„å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨éå¸¸ç›¸ä¼¼çš„æŠ€æœ¯æ¥é¿å…æ— é™çš„é‡æ–°æ¸²æŸ“ã€‚ä¸€ä¸ªæ˜¾è‘—çš„åŒºåˆ«æ˜¯ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»ç”¨`useCallback`æ›¿æ¢`useMemo`ã€‚*

æ„Ÿè°¢æ‚¨çš„é˜…è¯»ï¼

å¯¹ä»£ç å¾ˆå¥½å¥‡ï¼Ÿè‡ªå·±ç©[è¿™é‡Œ](https://codesandbox.io/s/useeffect-gotcha-20jw9?file=/src/App.js)ã€‚

è®¿é—®æˆ‘çš„[åšå®¢](https://blog.whereisthemouse.com/)å’Œ Twitter ä¸Šçš„[å…³æ³¨æˆ‘](https://twitter.com/iva_kop)ï¼Œäº†è§£æ›´å¤šä¸ React ç›¸å…³çš„å†…å®¹ã€‚

å›¾ç‰‡ç”± [vectorjuice](https://www.freepik.com/vectors/technology) æä¾›