# 2020 å¹´ JavaScript + Firestore æ•™ç¨‹:é€šè¿‡å®ä¾‹å­¦ä¹ 

> åŸæ–‡ï¼š<https://www.freecodecamp.org/news/the-firestore-tutorial-for-2020-learn-by-example/>

Cloud Firestore æ˜¯ä¸€ä¸ªé€Ÿåº¦æå¿«çš„æ— æœåŠ¡å™¨ NoSQL æ•°æ®åº“ï¼Œéå¸¸é€‚åˆæ”¯æŒä»»ä½•è§„æ¨¡çš„ web å’Œç§»åŠ¨åº”ç”¨ç¨‹åºã€‚[è·å–å­¦ä¹  Firestore](https://reedbarger.com/resources/javascript-firestore-2020/) çš„å®Œæ•´æŒ‡å—ï¼Œè¯¥æŒ‡å—æ—¨åœ¨å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Firestore ä½œä¸ºæ‚¨è‡ªå·±ä»¤äººæƒŠå¹çš„é¡¹ç›®çš„å¼•æ“ã€‚

## ç›®å½•

firestorm å…¥é—¨

*   ä»€ä¹ˆæ˜¯ Firestoreï¼Ÿä½ ä¸ºä»€ä¹ˆè¦ç”¨å®ƒï¼Ÿ
*   åœ¨ javascript é¡¹ç›®ä¸­è®¾ç½® firestorm
*   Firestore æ–‡æ¡£å’Œæ”¶è—
*   ç”¨ Firebase æ§åˆ¶å°ç®¡ç†æˆ‘ä»¬çš„æ•°æ®åº“

ç”¨ firestorm è·å–æ•°æ®

*   ä»é›†åˆä¸­è·å–æ•°æ®ã€‚è·å–()
*   ä½¿ç”¨è®¢é˜…é›†åˆã€‚onSnapshot()
*   ä¹‹é—´çš„åŒºåˆ«ã€‚get()å’Œã€‚onSnapshot()
*   å–æ¶ˆè®¢é˜…æ”¶è—
*   è·å–å•ä¸ªæ–‡æ¡£

ç”¨ firestorm æ”¹å˜æ•°æ®

*   ä½¿ç”¨å°†æ–‡æ¡£æ·»åŠ åˆ°é›†åˆä¸­ã€‚æ·»åŠ ()
*   å‘é›†åˆä¸­æ·»åŠ æ–‡æ¡£ã€‚é›†åˆ()
*   æ›´æ–°ç°æœ‰æ•°æ®
*   åˆ é™¤æ•°æ®

åŸºæœ¬æ¨¡å¼

*   ä½¿ç”¨å­é›†åˆ
*   ç«é£æš´é¢†åŸŸçš„æœ‰ç”¨æ–¹æ³•
*   ä½¿ç”¨æŸ¥è¯¢ã€‚å“ªé‡Œ()
*   è®¢è´­å’Œé™åˆ¶æ•°æ®

æ³¨æ„:ä½ å¯ä»¥ä¸‹è½½æœ¬æ•™ç¨‹çš„ PDF ç‰ˆæœ¬ï¼Œè¿™æ ·ä½ å°±å¯ä»¥ç¦»çº¿é˜…è¯»äº†ã€‚

### ä»€ä¹ˆæ˜¯ Firestoreï¼Ÿä½ ä¸ºä»€ä¹ˆè¦ç”¨å®ƒï¼Ÿ

Firestore æ˜¯ä¸€ä¸ªéå¸¸çµæ´»ã€æ˜“äºä½¿ç”¨çš„æ•°æ®åº“ï¼Œç”¨äºç§»åŠ¨ã€web å’ŒæœåŠ¡å™¨å¼€å‘ã€‚å¦‚æœä½ ç†Ÿæ‚‰ Firebase çš„å®æ—¶æ•°æ®åº“ï¼ŒFirestore æœ‰è®¸å¤šç›¸ä¼¼ä¹‹å¤„ï¼Œä½†æœ‰ä¸€ä¸ªä¸åŒçš„(å¯ä»¥è¯´æ›´å…·å£°æ˜æ€§çš„)APIã€‚

ä»¥ä¸‹æ˜¯ Firestore å¸¦æ¥çš„ä¸€äº›åŠŸèƒ½:

#### âš¡ï¸Easily å®æ—¶è·å–æ•°æ®

åƒ Firebase å®æ—¶æ•°æ®åº“ä¸€æ ·ï¼ŒFirestore æä¾›äº†ä¸€äº›æœ‰ç”¨çš„æ–¹æ³•ï¼Œå¦‚ã€‚onSnapshot()ï¼Œè®©å®æ—¶ç›‘å¬æ•°æ®æ›´æ–°è½»è€Œæ˜“ä¸¾ã€‚è¿™ä½¿å¾— Firestore æˆä¸ºé‡è§†æ˜¾ç¤ºå’Œä½¿ç”¨æœ€æ–°æ•°æ®çš„é¡¹ç›®(ä¾‹å¦‚èŠå¤©åº”ç”¨ç¨‹åº)çš„ç†æƒ³é€‰æ‹©ã€‚

#### ä½œä¸º NoSQL æ•°æ®åº“çš„çµæ´»æ€§

Firestore æ˜¯ä¸€ä¸ªéå¸¸çµæ´»çš„åç«¯é€‰æ‹©ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ª NoSQL æ•°æ®åº“ã€‚NoSQL æ„å‘³ç€æ•°æ®ä¸åƒæ ‡å‡† SQL æ•°æ®åº“é‚£æ ·å­˜å‚¨åœ¨è¡¨å’Œåˆ—ä¸­ã€‚å®ƒçš„ç»“æ„ç±»ä¼¼äºé”®å€¼å­˜å‚¨ï¼Œå°±å¥½åƒå®ƒæ˜¯ä¸€ä¸ªå¤§çš„ JavaScript å¯¹è±¡ã€‚

æ¢å¥è¯è¯´ï¼Œæ²¡æœ‰æ¨¡å¼æˆ–éœ€è¦æ¥æè¿°æˆ‘ä»¬çš„æ•°æ®åº“å°†å­˜å‚¨ä»€ä¹ˆæ•°æ®ã€‚åªè¦æˆ‘ä»¬æä¾›æœ‰æ•ˆçš„å¯†é’¥å’Œå€¼ï¼ŒFirestore å°±ä¼šå­˜å‚¨å®ƒã€‚

#### â†•ï¸å¯è½»æ¾æ‰©å±•

ä¸ºæ‚¨çš„æ•°æ®åº“é€‰æ‹© Firestore çš„ä¸€å¤§å¥½å¤„æ˜¯ï¼Œå®ƒæ„å»ºäº†éå¸¸å¼ºå¤§çš„åŸºç¡€è®¾æ–½ï¼Œä½¿æ‚¨èƒ½å¤Ÿéå¸¸è½»æ¾åœ°æ‰©å±•æ‚¨çš„åº”ç”¨ç¨‹åºã€‚çºµå‘å’Œæ¨ªå‘éƒ½æ˜¯å¦‚æ­¤ã€‚ä¸ç®¡ä½ æœ‰å‡ ç™¾è¿˜æ˜¯å‡ ç™¾ä¸‡ç”¨æˆ·ã€‚è°·æ­Œçš„æœåŠ¡å™¨å°†èƒ½å¤Ÿå¤„ç†ä½ åŠ åœ¨å®ƒèº«ä¸Šçš„ä»»ä½•è´Ÿè½½ã€‚

ç®€è€Œè¨€ä¹‹ï¼ŒFirestore æ˜¯å°å‹å’Œå¤§å‹åº”ç”¨ç¨‹åºçš„ç»ä½³é€‰æ‹©ã€‚å¯¹äºå°å‹åº”ç”¨ç¨‹åºæ¥è¯´ï¼Œå®ƒéå¸¸å¼ºå¤§ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ä¸ç”¨å¤ªå¤šçš„è®¾ç½®å°±å¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼Œå¹¶ä¸”å¯ä»¥éå¸¸å¿«é€Ÿåœ°åˆ›å»ºé¡¹ç›®ã€‚ç”±äº Firestore çš„å¯æ‰©å±•æ€§ï¼Œå®ƒéå¸¸é€‚åˆå¤§å‹é¡¹ç›®ã€‚

### åœ¨ javascript é¡¹ç›®ä¸­è®¾ç½® firestorm

> æˆ‘ä»¬å°†ä½¿ç”¨ Firestore SDK çš„ JavaScriptã€‚åœ¨æ•´ç¯‡å¤‡å¿˜å•ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•åœ¨ JavaScript é¡¹ç›®çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ Firestoreã€‚å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œè®¨è®ºçš„æ¦‚å¿µå¯ä»¥å¾ˆå®¹æ˜“åœ°ç§»æ¤åˆ°ä»»ä½•å¯ç”¨çš„ Firestore å®¢æˆ·ç«¯åº“ä¸­ã€‚

è¦å¼€å§‹ä½¿ç”¨ Firestoreï¼Œæˆ‘ä»¬å°†å‰å¾€ Firebase æ§åˆ¶å°ã€‚ä½ å¯ä»¥å» firebase.google.com å‚è§‚ã€‚æ‚¨éœ€è¦æœ‰ä¸€ä¸ª Google å¸æˆ·æ‰èƒ½ç™»å½•ã€‚

![firebase](img/447b808b6f7231e51523a3921f379ec5.png)

ç™»å½•åï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®å¹¶ä¸ºå…¶å‘½åã€‚

![create-a-project](img/e215f3351a811d5fcbec8e88f4b64520.png)

ä¸€æ—¦æˆ‘ä»¬çš„é¡¹ç›®è¢«åˆ›å»ºï¼Œæˆ‘ä»¬å°†é€‰æ‹©å®ƒã€‚ä¹‹åï¼Œåœ¨æˆ‘ä»¬é¡¹ç›®çš„ä»ªè¡¨æ¿ä¸Šï¼Œæˆ‘ä»¬å°†é€‰æ‹© code æŒ‰é’®ã€‚

è¿™å°†ä¸ºæˆ‘ä»¬æä¾›å°† Firestore ä¸ JavaScript é¡¹ç›®é›†æˆæ‰€éœ€çš„ä»£ç ã€‚

![firebase-integration](img/549a70fdf8436c68b8374d9b8b890cf7.png)

é€šå¸¸ï¼Œå¦‚æœæ‚¨åœ¨ä»»ä½•ç±»å‹çš„ JavaScript åº”ç”¨ç¨‹åºä¸­è®¾ç½®å®ƒï¼Œæ‚¨ä¼šå¸Œæœ›å°†å®ƒæ”¾åœ¨ä¸€ä¸ªåä¸º firebase.js çš„ä¸“ç”¨æ–‡ä»¶ä¸­ã€‚å¦‚æœæ‚¨ä½¿ç”¨ä»»ä½•åŒ…å« package.json æ–‡ä»¶çš„ JavaScript åº“ï¼Œæ‚¨ä¼šå¸Œæœ›ä½¿ç”¨ npm æˆ– yarn å®‰è£… firebase ä¾èµ–é¡¹ã€‚

```
// with npm
npm i firebase

// with yarn
yarn add firebase
```

Firestore å¯ä»¥åœ¨å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨ä¸Šä½¿ç”¨ã€‚å¦‚æœæ‚¨å°† Firestore ä¸ Node ä¸€èµ·ä½¿ç”¨ï¼Œåˆ™éœ€è¦å°† CommonJS è¯­æ³•ä¸ require ä¸€èµ·ä½¿ç”¨ã€‚å¦åˆ™ï¼Œå¦‚æœæ‚¨åœ¨å®¢æˆ·ç«¯ä½¿ç”¨ JavaScriptï¼Œæ‚¨å°†ä½¿ç”¨ ES æ¨¡å—å¯¼å…¥ firebaseã€‚

```
// with Commonjs syntax (if using Node)
const firebase = require("firebase/app");
require("firebase/firestore");

// with ES Modules (if using client-side JS, like React)
import firebase from 'firebase/app';
import 'firebase/firestore';

var firebaseConfig = {
  apiKey: "AIzaSyDpLmM79mUqbMDBexFtOQOkSl0glxCW_ds",
  authDomain: "lfasdfkjkjlkjl.firebaseapp.com",
  databaseURL: "https://lfasdlkjkjlkjl.firebaseio.com",
  projectId: "lfasdlkjkjlkjl",
  storageBucket: "lfasdlkjkjlkjl.appspot.com",
  messagingSenderId: "616270824980",
  appId: "1:616270824990:web:40c8b177c6b9729cb5110f",
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
```

### Firestore æ”¶è—å’Œæ–‡ä»¶

æœ‰ä¸¤ä¸ªå…³é”®æœ¯è¯­å¯¹äºç†è§£å¦‚ä½•ä½¿ç”¨ Firestore è‡³å…³é‡è¦:**æ–‡æ¡£**å’Œ**æ”¶è—**ã€‚

æ–‡æ¡£æ˜¯æˆ‘ä»¬æ•°æ®åº“ä¸­çš„ç‹¬ç«‹æ•°æ®ã€‚æ‚¨å¯ä»¥å°†æ–‡æ¡£æƒ³è±¡æˆç®€å•çš„ JavaScript å¯¹è±¡ã€‚å®ƒä»¬ç”±é”®å€¼å¯¹ç»„æˆï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º**å­—æ®µ**ã€‚è¿™äº›å­—æ®µçš„å€¼å¯ä»¥æ˜¯å­—ç¬¦ä¸²ã€æ•°å­—ã€å¸ƒå°”å€¼ã€å¯¹è±¡ã€æ•°ç»„ï¼Œç”šè‡³æ˜¯äºŒè¿›åˆ¶æ•°æ®ã€‚

```
document -> { key: value } 
```

è¿™äº›æ–‡æ¡£çš„é›†åˆè¢«ç§°ä¸ºé›†åˆã€‚é›†åˆéå¸¸åƒå¯¹è±¡çš„æ•°ç»„ã€‚åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œæ¯ä¸ªæ–‡æ¡£éƒ½é“¾æ¥åˆ°ä¸€ä¸ªç»™å®šçš„æ ‡è¯†ç¬¦(id)ã€‚

```
collection -> [{ id: doc }, { id: doc }]
```

### ç”¨ firestorm æ§åˆ¶å°ç®¡ç†æˆ‘ä»¬çš„æ•°æ®åº“

åœ¨æˆ‘ä»¬çœŸæ­£å¼€å§‹ä½¿ç”¨æ•°æ®åº“ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºå®ƒã€‚

åœ¨æˆ‘ä»¬çš„ Firebase æ§åˆ¶å°ä¸­ï¼Œè½¬åˆ°â€œæ•°æ®åº“â€é€‰é¡¹å¡å¹¶åˆ›å»ºæ‚¨çš„ Firestore æ•°æ®åº“ã€‚

![firestore](img/8918f8f403c070f6d64dc7c6e6ac1ac3.png)

å®Œæˆåï¼Œæˆ‘ä»¬å°†å¼€å§‹æµ‹è¯•æ¨¡å¼ï¼Œå¹¶å¯ç”¨å¯¹æ•°æ®åº“çš„æ‰€æœ‰è¯»å†™æ“ä½œã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å°†å¼€æ”¾è·å–å’Œæ›´æ”¹æ•°æ®åº“ä¸­çš„æ•°æ®ã€‚å¦‚æœæˆ‘ä»¬è¦æ·»åŠ  Firebase èº«ä»½éªŒè¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†è®¿é—®æƒé™ä»…é™äºç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ã€‚

ä¹‹åï¼Œæˆ‘ä»¬å°†è¢«å¸¦åˆ°æˆ‘ä»¬çš„æ•°æ®åº“æœ¬èº«ï¼Œåœ¨é‚£é‡Œæˆ‘ä»¬å¯ä»¥å¼€å§‹åˆ›å»ºé›†åˆå’Œæ–‡æ¡£ã€‚æˆ‘ä»¬çš„æ•°æ®åº“çš„æ ¹å°†æ˜¯ä¸€ç³»åˆ—é›†åˆï¼Œæ‰€ä»¥è®©æˆ‘ä»¬åˆ¶ä½œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªé›†åˆã€‚

æˆ‘ä»¬å¯ä»¥é€‰æ‹©â€œå¼€å§‹æ”¶é›†â€å¹¶ç»™å®ƒä¸€ä¸ª idã€‚æ¯ä¸ªæ”¶è—éƒ½ä¼šæœ‰ä¸€ä¸ª id æˆ–è€…åå­—ã€‚å¯¹äºæˆ‘ä»¬çš„é¡¹ç›®ï¼Œæˆ‘ä»¬å°†è·Ÿè¸ªç”¨æˆ·æœ€å–œæ¬¢çš„ä¹¦ç±ã€‚æˆ‘ä»¬å°†ç»™æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç³»åˆ—å‘½åä¸ºâ€œä¹¦ç±â€ã€‚

![collection-id](img/2dc54b9751694df469a1366338c8434d.png)

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æŠŠç¬¬ä¸€ä¸ªæ–‡æ¡£æ·»åŠ åˆ°æ–°åˆ›å»ºçš„â€œbooksâ€é›†åˆä¸­ã€‚

æ¯ä¸ªæ–‡æ¡£ä¹Ÿå°†æœ‰ä¸€ä¸ª idï¼Œå°†å®ƒé“¾æ¥åˆ°å®ƒæ‰€åœ¨çš„é›†åˆã€‚

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªé€‰é¡¹æ¥ç»™å®ƒä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„ IDã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç‚¹å‡»æŒ‰é’®â€œauto idâ€æ¥è¿™æ ·åšï¼Œä¹‹åæˆ‘ä»¬éœ€è¦æä¾›ä¸€ä¸ªå­—æ®µï¼Œç»™å®ƒä¸€ä¸ªç±»å‹ï¼Œä»¥åŠä¸€ä¸ªå€¼ã€‚

å¯¹äºæˆ‘ä»¬çš„ç¬¬ä¸€æœ¬ä¹¦ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªâ€œstringâ€ç±»å‹çš„â€œtitleâ€å­—æ®µï¼Œå€¼ä¸ºâ€œThe Great Gatsby â€,ç„¶åç‚¹å‡» saveã€‚

ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥ä¼šçœ‹åˆ°æˆ‘ä»¬çš„æ•°æ®åº“ä¸­çš„ç¬¬ä¸€ä¸ªé¡¹ç›®ã€‚

![first-item](img/a53352f1fa89678c975ab1d8659313da.png)

### ä»é›†åˆä¸­è·å–æ•°æ®ã€‚è·å–()

ä¸ºäº†ä½¿ç”¨ Firestore æä¾›çš„æ‰€æœ‰æ–¹æ³•ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`firebase.firestore()`ã€‚æ¯å½“æˆ‘ä»¬æƒ³è¦ä¸ Firestore æ•°æ®åº“è¿›è¡Œäº¤äº’æ—¶ï¼Œéƒ½éœ€è¦æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ã€‚

æˆ‘å»ºè®®åˆ›å»ºä¸€ä¸ªä¸“ç”¨å˜é‡æ¥å­˜å‚¨å¯¹ Firestore çš„å•ä¸ªå¼•ç”¨ã€‚è¿™æ ·åšæœ‰åŠ©äºå‡å°‘ä½ åœ¨åº”ç”¨ç¨‹åºä¸­ç¼–å†™çš„ä»£ç é‡ã€‚

```
const db = firebase.firestore(); 
```

> ç„¶è€Œï¼Œåœ¨è¿™ä»½å¤‡å¿˜å•ä¸­ï¼Œæˆ‘å°†åšæŒæ¯æ¬¡éƒ½ä½¿ç”¨ firestore æ–¹æ³•ï¼Œä»¥å°½å¯èƒ½æ¸…æ™°æ˜äº†ã€‚

ä¸ºäº†å¼•ç”¨ä¸€ä¸ªé›†åˆï¼Œæˆ‘ä»¬ä½¿ç”¨`.collection()`æ–¹æ³•å¹¶æä¾›ä¸€ä¸ªé›†åˆçš„ id ä½œä¸ºå‚æ•°ã€‚è¦è·å–å¯¹æˆ‘ä»¬åˆ›å»ºçš„å›¾ä¹¦é›†åˆçš„å¼•ç”¨ï¼Œåªéœ€ä¼ å…¥å­—ç¬¦ä¸²â€œbooksâ€ã€‚

```
const booksRef = firebase.firestore().collection('books');
```

ä¸ºäº†ä»é›†åˆä¸­è·å–æ‰€æœ‰çš„æ–‡æ¡£æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`.get()`æ–¹æ³•ã€‚

`.get()`è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`.then()`å›è°ƒæ¥è§£å†³å®ƒï¼Œæˆ–è€…å¦‚æœæˆ‘ä»¬åœ¨å¼‚æ­¥å‡½æ•°ä¸­æ‰§è¡Œä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ async-await è¯­æ³•ã€‚

ä¸€æ—¦æˆ‘ä»¬çš„æ‰¿è¯ºä»¥è¿™æ ·æˆ–é‚£æ ·çš„æ–¹å¼å®ç°äº†ï¼Œæˆ‘ä»¬å°±ä¼šå¾—åˆ°æ‰€è°“çš„**å¿«ç…§**ã€‚

å¯¹äºé›†åˆæŸ¥è¯¢ï¼Œå¿«ç…§å°†ç”±è®¸å¤šå•ç‹¬çš„æ–‡æ¡£ç»„æˆã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¯´`snapshot.docs`æ¥è®¿é—®å®ƒä»¬ã€‚

ä»æ¯ä¸ªæ–‡æ¡£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—ä½œä¸ºå•ç‹¬å±æ€§çš„ idï¼Œå…¶ä½™çš„æ•°æ®ä½¿ç”¨`.data()`æ–¹æ³•ã€‚

ä¸‹é¢æ˜¯æˆ‘ä»¬æ•´ä¸ªæŸ¥è¯¢çš„æ ·å­:

```
const booksRef = firebase
  .firestore()
  .collection("books");

booksRef
  .get()
  .then((snapshot) => {
    const data = snapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));
    console.log("All data in 'books' collection", data); 
    // [ { id: 'glMeZvPpTN1Ah31sKcnj', title: 'The Great Gatsby' } ]
  });
```

### ä½¿ç”¨è®¢é˜…é›†åˆã€‚onSnapshot()

`.get()`æ–¹æ³•ç®€å•åœ°è¿”å›æˆ‘ä»¬é›†åˆä¸­çš„æ‰€æœ‰æ•°æ®ã€‚

ä¸ºäº†åˆ©ç”¨ Firestore çš„ä¸€äº›å®æ—¶åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥è®¢é˜…ä¸€ä¸ªé›†åˆï¼Œæ¯å½“é›†åˆä¸­çš„æ–‡æ¡£è¢«æ›´æ–°æ—¶ï¼Œå®ƒå°±ä¼šæä¾›ç»™æˆ‘ä»¬è¿™äº›æ–‡æ¡£çš„å½“å‰å€¼ã€‚

æˆ‘ä»¬ä¸ä½¿ç”¨ç”¨äºæŸ¥è¯¢å•ä¸ªæ—¶é—´çš„`.get()`æ–¹æ³•ï¼Œè€Œæ˜¯ä½¿ç”¨`.onSnapshot()`æ–¹æ³•ã€‚

```
firebase
  .firestore()
  .collection("books")
  .onSnapshot((snapshot) => {
    const data = snapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));
    console.log("All data in 'books' collection", data);
  });
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†æ‰€è°“çš„æ–¹æ³•é“¾æ¥ï¼Œè€Œä¸æ˜¯åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å˜é‡æ¥å¼•ç”¨é›†åˆã€‚

ä½¿ç”¨ firestore çš„å¼ºå¤§ä¹‹å¤„åœ¨äºï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ç³»åˆ—æ–¹æ³•ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°é“¾æ¥èµ·æ¥ï¼Œä»è€Œäº§ç”Ÿæ›´å…·å£°æ˜æ€§ã€å¯è¯»æ€§æ›´å¼ºçš„ä»£ç ã€‚

åœ¨ onSnapshot çš„å›è°ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥è®¿é—®é›†åˆçš„å¿«ç…§ï¼Œæ— è®ºæ˜¯ç°åœ¨è¿˜æ˜¯å°†æ¥æ›´æ–°çš„æ—¶å€™ã€‚å°è¯•æ‰‹åŠ¨æ›´æ–°æˆ‘ä»¬çš„ä¸€ä¸ªæ–‡æ¡£ï¼Œæ‚¨ä¼šçœ‹åˆ°`.onSnapshot()`æ­£åœ¨ç›‘å¬è¿™ä¸ªé›†åˆä¸­çš„ä»»ä½•æ›´æ”¹ã€‚

### ä¹‹é—´çš„åŒºåˆ«ã€‚get()å’Œã€‚onSnapshot()

get å’Œ snapshot æ–¹æ³•çš„åŒºåˆ«åœ¨äº get è¿”å›ä¸€ä¸ªéœ€è¦è§£å†³çš„æ‰¿è¯ºï¼Œåªæœ‰è¿™æ ·æˆ‘ä»¬æ‰èƒ½è·å¾—å¿«ç…§æ•°æ®ã€‚

ç„¶è€Œ,`.onSnapshot`ä½¿ç”¨åŒæ­¥å›è°ƒå‡½æ•°ï¼Œå®ƒè®©æˆ‘ä»¬å¯ä»¥ç›´æ¥è®¿é—®å¿«ç…§ã€‚

å½“æ¶‰åŠåˆ°è¿™äº›ä¸åŒçš„æ–¹æ³•æ—¶ï¼Œè®°ä½è¿™ä¸€ç‚¹å¾ˆé‡è¦â€”â€”æˆ‘ä»¬å¿…é¡»çŸ¥é“å®ƒä»¬ä¸­çš„å“ªäº›è¿”å›æ‰¿è¯ºï¼Œå“ªäº›æ˜¯åŒæ­¥çš„ã€‚

### ä½¿ç”¨ unsubscribe()å–æ¶ˆè®¢é˜…æ”¶è—

å¦å¤–è¯·æ³¨æ„ï¼Œ`.onSnapshot()`è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥å–æ¶ˆè®¢é˜…å’Œåœæ­¢ç›‘å¬ç»™å®šçš„é›†åˆã€‚

ä¾‹å¦‚ï¼Œå½“ç”¨æˆ·ç¦»å¼€æ˜¾ç¤ºé›†åˆæ•°æ®çš„ç»™å®šé¡µé¢æ—¶ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªä¾‹å­ï¼Œä½¿ç”¨ React åº“ï¼Œæˆ‘ä»¬åœ¨ useEffect é’©å­ä¸­è°ƒç”¨ unsubscribeã€‚

å½“æˆ‘ä»¬è¿™æ ·åšæ—¶ï¼Œè¿™å°†ç¡®ä¿å½“æˆ‘ä»¬çš„ç»„ä»¶è¢«å¸è½½(ä¸å†æ˜¾ç¤ºåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„ä¸Šä¸‹æ–‡ä¸­)æ—¶ï¼Œæˆ‘ä»¬ä¸å†ä¾¦å¬æˆ‘ä»¬åœ¨è¯¥ç»„ä»¶ä¸­ä½¿ç”¨çš„æ”¶é›†æ•°æ®ã€‚

```
function App() {
  const [books, setBooks] = React.useState([]);

  React.useEffect(() => {
	const unsubscribe = firebase
      .firestore()
      .collection("books")
      .onSnapshot((snapshot) => {
        const data = snapshot.docs.map((doc) => ({
          id: doc.id,
          ...doc.data(),
        }));
		setBooks(data);
      });
  }, []);

  return books.map(book => <BookList key={book.id} book={book} />)
}
```

### è·å–å•ä¸ªæ–‡æ¡£ã€‚æ–‡æ¡£()

åœ¨è·å–é›†åˆä¸­çš„æ–‡æ¡£æ—¶ã€‚ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸è·å–æ•´ä¸ªé›†åˆæ˜¯ä¸€æ ·çš„:æˆ‘ä»¬éœ€è¦é¦–å…ˆåˆ›å»ºä¸€ä¸ªå¯¹è¯¥æ–‡æ¡£çš„å¼•ç”¨ï¼Œç„¶åä½¿ç”¨ get æ–¹æ³•è·å–å®ƒã€‚

ç„¶è€Œï¼Œåœ¨é‚£ä¹‹åï¼Œæˆ‘ä»¬ä½¿ç”¨é“¾æ¥åˆ°é›†åˆæ–¹æ³•ä¸Šçš„`.doc()`æ–¹æ³•ã€‚ä¸ºäº†åˆ›å»ºä¸€ä¸ªå¼•ç”¨ï¼Œæˆ‘ä»¬éœ€è¦ä»æ•°æ®åº“ä¸­è·å–è¿™ä¸ª idï¼Œå¦‚æœå®ƒæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ã€‚ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é“¾ä¸Š`.get()`å¹¶è§£ææ‰¿è¯ºã€‚

```
const bookRef = firebase
  .firestore()
  .collection("books")
  .doc("glMeZvPpTN1Ah31sKcnj");

bookRef.get().then((doc) => {
  if (!doc.exists) return;
  console.log("Document data:", doc.data());
  // Document data: { title: 'The Great Gatsby' }
});
```

æ³¨æ„ä¸Šé¢ä»£ç ä¸­çš„æ¡ä»¶`if (!doc.exists) return;`ã€‚

ä¸€æ—¦æˆ‘ä»¬å–å›äº†æ–‡æ¡£ï¼Œå°±å¿…é¡»æ£€æŸ¥å®ƒæ˜¯å¦å­˜åœ¨ã€‚

å¦‚æœæˆ‘ä»¬ä¸è¿™æ ·åšï¼Œåœ¨è·å–æˆ‘ä»¬çš„æ–‡æ¡£æ•°æ®æ—¶å°±ä¼šå‡ºé”™ã€‚æ£€æŸ¥æˆ‘ä»¬çš„æ–‡æ¡£æ˜¯å¦å­˜åœ¨çš„æ–¹æ³•æ˜¯é€šè¿‡è¯´ï¼Œif `doc.exists`ï¼Œå®ƒè¿”å›ä¸€ä¸ª true æˆ– false å€¼ã€‚

å¦‚æœè¿™ä¸ªè¡¨è¾¾å¼è¿”å› falseï¼Œæˆ‘ä»¬å¸Œæœ›ä»å‡½æ•°è¿”å›æˆ–è€…æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚å¦‚æœ`doc.exists`ä¸ºçœŸï¼Œæˆ‘ä»¬å¯ä»¥ä»`doc.data`å¾—åˆ°æ•°æ®ã€‚

### ä½¿ç”¨å°†æ–‡æ¡£æ·»åŠ åˆ°é›†åˆä¸­ã€‚æ·»åŠ ()

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ç»§ç»­æ›´æ”¹æ•°æ®ã€‚å‘é›†åˆä¸­æ·»åŠ æ–°æ–‡æ¡£æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨`.add()`æ–¹æ³•ã€‚

ä½ æ‰€éœ€è¦åšçš„å°±æ˜¯é€‰æ‹©ä¸€ä¸ªé›†åˆå¼•ç”¨(å¸¦æœ‰`.collection()`)å¹¶é“¾æ¥åˆ°`.add()`ã€‚

å›åˆ°æˆ‘ä»¬å¯¹æ–‡æ¡£çš„å®šä¹‰ï¼Œå°±åƒ JavaScript å¯¹è±¡ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªå¯¹è±¡ä¼ é€’ç»™`.add()`æ–¹æ³•ï¼Œå¹¶æŒ‡å®šæˆ‘ä»¬å¸Œæœ›å‡ºç°åœ¨æ–‡æ¡£ä¸­çš„æ‰€æœ‰å­—æ®µã€‚

å‡è®¾æˆ‘ä»¬æƒ³æ·»åŠ å¦ä¸€æœ¬ä¹¦ã€Šäººé¼ ä¹‹é—´ã€‹:

```
firebase
  .firestore()
  .collection("books")
  .add({
    title: "Of Mice and Men",
  })
  .then((ref) => {
    console.log("Added doc with ID: ", ref.id);
    // Added doc with ID:  ZzhIgLqELaoE3eSsOazu
  });
```

`.add`æ–¹æ³•è¿”å›ä¸€ä¸ªæ‰¿è¯ºï¼Œä»è¿™ä¸ªå·²è§£æçš„æ‰¿è¯ºä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªå¯¹å·²åˆ›å»ºæ–‡æ¡£çš„å¼•ç”¨ï¼Œè¿™ç»™äº†æˆ‘ä»¬ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚å·²åˆ›å»ºçš„ idã€‚

æ–¹æ³•è‡ªåŠ¨ä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ª idã€‚æ³¨æ„ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥ä½¿ç”¨è¿™ä¸ªå¼•ç”¨æ¥è·å–æ•°æ®ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å¯ä»¥å°† ref ä¼ é€’ç»™ doc æ–¹æ³•æ¥åˆ›å»ºå¦ä¸€ä¸ªæŸ¥è¯¢ã€‚

### å‘é›†åˆä¸­æ·»åŠ æ–‡æ¡£ã€‚é›†åˆ()

å°†æ–‡æ¡£æ·»åŠ åˆ°é›†åˆçš„å¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨`.set()`æ–¹æ³•ã€‚

set ä¸ add çš„ä¸åŒä¹‹å¤„åœ¨äºéœ€è¦åœ¨æ·»åŠ æ•°æ®æ—¶æŒ‡å®šæˆ‘ä»¬è‡ªå·±çš„ idã€‚

è¿™éœ€è¦ç”¨æ‚¨æƒ³è¦ä½¿ç”¨çš„ id é“¾æ¥åˆ°`.doc()`æ–¹æ³•ä¸Šã€‚å¦å¤–ï¼Œè¯·æ³¨æ„å½“ä»`.set()`è§£ææ‰¿è¯ºæ—¶ï¼Œæˆ‘ä»¬æ²¡æœ‰è·å¾—å¯¹å·²åˆ›å»ºæ–‡æ¡£çš„å¼•ç”¨:

```
firebase
  .firestore()
  .collection("books")
  .doc("another book")
  .set({
    title: "War and Peace",
  })
  .then(() => {
    console.log("Document created");
  });
```

æ­¤å¤–ï¼Œå½“æˆ‘ä»¬å¯¹ä¸€ä¸ªç°æœ‰æ–‡æ¡£ä½¿ç”¨`.set()`æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä¼šè¦†ç›–é‚£ä¸ªæ–‡æ¡£ã€‚

å¦‚æœæˆ‘ä»¬æƒ³è¦åˆå¹¶ä¸€ä¸ªæ—§æ–‡æ¡£å’Œä¸€ä¸ªæ–°æ–‡æ¡£ï¼Œè€Œä¸æ˜¯è¦†ç›–å®ƒï¼Œæˆ‘ä»¬éœ€è¦ä¼ é€’ä¸€ä¸ªé¢å¤–çš„å‚æ•°ç»™`.set()`å¹¶æä¾›è®¾ç½®ä¸º true çš„å±æ€§`merge`ã€‚

```
// use .set() to merge data with existing document, not overwrite

const bookRef = firebase
  .firestore()
  .collection("books")
  .doc("another book");

bookRef
  .set({
    author: "Lev Nikolaevich Tolstoy"
  }, { merge: true })
  .then(() => {
    console.log("Document merged");

    bookRef
      .get()
      .then(doc => {
      console.log("Merged document: ", doc.data());
      // Merged document:  { title: 'War and Peace', author: 'Lev Nikolaevich Tolstoy' }
    });
  });
```

### ä½¿ç”¨æ›´æ–°ç°æœ‰æ•°æ®ã€‚æ›´æ–°()

å½“æ¶‰åŠåˆ°æ›´æ–°æ•°æ®æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ update æ–¹æ³•ï¼Œåƒ`.add()`å’Œ`.set()`å®ƒè¿”å›ä¸€ä¸ªæ‰¿è¯ºã€‚

ä½¿ç”¨`.update()`çš„å¥½å¤„åœ¨äºï¼Œä¸`.set()`ä¸åŒï¼Œå®ƒä¸ä¼šè¦†ç›–æ•´ä¸ªæ–‡æ¡£ã€‚ä¹Ÿåƒ`.set()`ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦å¼•ç”¨ä¸€ä¸ªå•ç‹¬çš„æ–‡æ¡£ã€‚

å½“æ‚¨ä½¿ç”¨`.update()`æ—¶ï¼Œä½¿ç”¨ä¸€äº›é”™è¯¯å¤„ç†æ˜¯å¾ˆé‡è¦çš„ï¼Œæ¯”å¦‚åœ¨æ–‡æ¡£ä¸å­˜åœ¨çš„æƒ…å†µä¸‹ä½¿ç”¨`.catch()`å›è°ƒã€‚

```
const bookRef = firebase.firestore().collection("books").doc("another book");

bookRef
  .update({
    year: 1869,
  })
  .then(() => {
    console.log("Document updated"); // Document updated
  })
  .catch((error) => {
    console.error("Error updating doc", error);
  }); 
```

### ä½¿ç”¨åˆ é™¤æ•°æ®ã€‚åˆ é™¤()

æˆ‘ä»¬å¯ä»¥é€šè¿‡ id å¼•ç”¨ç»™å®šçš„æ–‡æ¡£é›†åˆå¹¶æ‰§è¡Œ`.delete()`æ–¹æ³•æ¥åˆ é™¤å®ƒï¼Œå°±è¿™ä¹ˆç®€å•ã€‚å®ƒè¿˜ä¼šè¿”å›ä¸€ä¸ªæ‰¿è¯ºã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªåˆ é™¤ id ä¸ºâ€œå¦ä¸€æœ¬ä¹¦â€çš„ä¹¦çš„åŸºæœ¬ç¤ºä¾‹:

```
firebase
  .firestore()
  .collection("books")
  .doc("another book")
  .delete()
  .then(() => console.log("Document deleted")) // Document deleted
  .catch((error) => console.error("Error deleting document", error));
```

> è¯·æ³¨æ„ï¼ŒFirestore å®˜æ–¹æ–‡æ¡£ä¸å»ºè®®åˆ é™¤æ•´ä¸ªç³»åˆ—ï¼Œåªå»ºè®®åˆ é™¤å•ä¸ªæ–‡æ¡£ã€‚

### ä½¿ç”¨å­é›†åˆ

å‡è®¾æˆ‘ä»¬åœ¨åˆ›å»ºåº”ç”¨ç¨‹åºæ—¶çŠ¯äº†ä¸€ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬ä¸ä»…ä»…æ˜¯æ·»åŠ ä¹¦ç±ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›å°†å®ƒä»¬ä¸åˆ¶ä½œå®ƒä»¬çš„ç”¨æˆ·è”ç³»èµ·æ¥ã€‚T

æˆ‘ä»¬æƒ³è¦é‡æ–°æ„é€ æ•°æ®çš„æ–¹æ³•æ˜¯åœ¨æ•°æ®åº“çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸ºâ€œusersâ€çš„é›†åˆï¼Œå¹¶å°†â€œbooksâ€ä½œä¸ºâ€œusersâ€çš„å­é›†åˆã€‚è¿™å°†å…è®¸ç”¨æˆ·æ‹¥æœ‰è‡ªå·±çš„è—ä¹¦ã€‚æˆ‘ä»¬å¦‚ä½•è®¾ç½®å®ƒï¼Ÿ

å¯¹å­é›†åˆâ€œbooksâ€çš„å¼•ç”¨åº”è¯¥å¦‚ä¸‹æ‰€ç¤º:

```
const userBooksRef = firebase
  .firestore()
  .collection('users')
  .doc('user-id')
  .collection('books');
```

å¦å¤–è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­£æ–œæ åœ¨å•ä¸ª`.collection()`è°ƒç”¨ä¸­ç¼–å†™æ‰€æœ‰è¿™äº›å†…å®¹ã€‚

ä¸Šé¢çš„ä»£ç ç­‰æ•ˆäºä¸‹é¢çš„ä»£ç ï¼Œå…¶ä¸­é›†åˆå¼•ç”¨å¿…é¡»æœ‰å¥‡æ•°ä¸ªæ®µã€‚å¦åˆ™ï¼ŒFirestore å°†æŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚

```
const userBooksRef = firebase
  .firestore()
  .collection('users/user-id/books');
```

ä¸ºäº†åˆ›å»ºå­é›†åˆæœ¬èº«ï¼Œç”¨ä¸€ä¸ªæ–‡æ¡£(å¦ä¸€éƒ¨æ–¯å¦è´å…‹çš„å°è¯´ã€Šä¼Šç”¸å›­ä¹‹ä¸œã€‹)è¿è¡Œä¸‹é¢çš„ä»£ç ã€‚

```
firebase.firestore().collection("users/user-1/books").add({
  title: "East of Eden",
});
```

ç„¶åï¼Œæ ¹æ®ç”¨æˆ·çš„ IDï¼Œè·å¾—æ–°åˆ›å»ºçš„å­é›†åˆå¦‚ä¸‹æ‰€ç¤ºã€‚

```
firebase
  .firestore()
  .collection("users/user-1/books")
  .get()
  .then((snapshot) => {
    const data = snapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));
    console.log(data); 
    // [ { id: 'UO07aqpw13xvlMAfAvTF', title: 'East of Eden' } ]
  });
```

### ç«é£æš´é¢†åŸŸçš„æœ‰ç”¨æ–¹æ³•

æˆ‘ä»¬å¯ä»¥ä» Firestore è·å¾—ä¸€äº›æœ‰ç”¨çš„å·¥å…·ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿæ›´è½»æ¾åœ°å¤„ç†æˆ‘ä»¬çš„å­—æ®µå€¼ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`FieldValue`å±æ€§ä¸­çš„ä»¥ä¸‹å¸®åŠ©å™¨ä¸ºç»™å®šæ–‡æ¡£çš„åˆ›å»ºæˆ–æ›´æ–°ç”Ÿæˆæ—¶é—´æˆ³ã€‚

æˆ‘ä»¬å½“ç„¶å¯ä»¥ä½¿ç”¨ JavaScript åˆ›å»ºè‡ªå·±çš„æ—¥æœŸå€¼ï¼Œä½†æ˜¯ä½¿ç”¨æœåŠ¡å™¨æ—¶é—´æˆ³å¯ä»¥è®©æˆ‘ä»¬ç¡®åˆ‡åœ°çŸ¥é“ Firestore æœ¬èº«çš„æ•°æ®æ˜¯ä½•æ—¶æ›´æ”¹æˆ–åˆ›å»ºçš„ã€‚

```
firebase
  .firestore()
  .collection("users")
  .doc("user-2")
  .set({
    created: firebase.firestore.FieldValue.serverTimestamp(),
  })
  .then(() => {
    console.log("Added user"); // Added user
  });
```

æ­¤å¤–ï¼Œå‡è®¾æˆ‘ä»¬åœ¨ä¸€ä¸ªæ–‡æ¡£ä¸­æœ‰ä¸€ä¸ªå­—æ®µï¼Œè®°å½•æŸä¸ªæ•°å­—ï¼Œæ¯”å¦‚æŸä¸ªç”¨æˆ·å·²ç»åˆ›å»ºäº†å¤šå°‘æœ¬ä¹¦ã€‚æ¯å½“ç”¨æˆ·åˆ›å»ºä¸€æœ¬æ–°ä¹¦æ—¶ï¼Œæˆ‘ä»¬éƒ½å¸Œæœ›å¢åŠ  1ã€‚

ä¸€ç§ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨å¦ä¸€ä¸ªåä¸º`.increment()`çš„å­—æ®µå€¼åŠ©æ‰‹ï¼Œè€Œä¸æ˜¯é¦–å…ˆå‘å‡ºä¸€ä¸ª`.get()`è¯·æ±‚:

```
const userRef = firebase.firestore().collection("users").doc("user-2");

userRef
  .set({
    count: firebase.firestore.FieldValue.increment(1),
  })
  .then(() => {
    console.log("Updated user");

    userRef.get().then((doc) => {
      console.log("Updated user data: ", doc.data());
    });
  }); 
```

### ä½¿ç”¨æŸ¥è¯¢ã€‚å“ªé‡Œ()

å¦‚æœæˆ‘ä»¬å¸Œæœ›æ ¹æ®ç‰¹å®šæ¡ä»¶ä»æˆ‘ä»¬çš„é›†åˆä¸­è·å–æ•°æ®ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æƒ³è¦è·å¾—æäº¤äº†ä¸€æœ¬ä¹¦æˆ–å¤šæœ¬ä¹¦çš„æ‰€æœ‰ç”¨æˆ·ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨`.where()`æ–¹æ³•çš„å¸®åŠ©ä¸‹ç¼–å†™è¿™æ ·ä¸€ä¸ªæŸ¥è¯¢ã€‚é¦–å…ˆæˆ‘ä»¬å¼•ç”¨ä¸€ä¸ªé›†åˆï¼Œç„¶åé“¾æ¥åˆ°`.where()`ã€‚

where æ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°â€”â€”é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨æ“ä½œä¸­æœç´¢çš„å­—æ®µï¼Œä¸€ä¸ªæ“ä½œç¬¦ï¼Œç„¶åæ˜¯æˆ‘ä»¬å¸Œæœ›ç”¨æ¥è¿‡æ»¤é›†åˆçš„å€¼ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»»ä½•æ“ä½œç¬¦ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„å­—æ®µå¯ä»¥æ˜¯åŸå§‹å€¼å’Œæ•°ç»„ã€‚

`<`ã€`<=`ã€`==`ã€`>`ã€`>=`ã€`array-contains`ã€`in`æˆ–`array-contains-any`

è¦è·å–æäº¤äº†å¤šæœ¬ä¹¦çš„æ‰€æœ‰ç”¨æˆ·ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æŸ¥è¯¢ã€‚

åœ¨`.where()`ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦é“¾ä¸Š`.get()`ã€‚åœ¨è§£å†³æˆ‘ä»¬çš„æ‰¿è¯ºæ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°äº†æ‰€è°“çš„**æŸ¥è¯¢å¿«ç…§**ã€‚

å°±åƒè·å–é›†åˆä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨`.map()`éå† querySnapshot æ¥è·å–æ¯ä¸ªæ–‡æ¡£çš„ id å’Œæ•°æ®(å­—æ®µ):

```
firebase
  .firestore()
  .collection("users")
  .where("count", ">=", 1)
  .get()
  .then((querySnapshot) => {
    const data = querySnapshot.docs.map((doc) => ({
      id: doc.id,
      ...doc.data(),
    }));
    console.log("Users with > 1 book: ", data);
    // Users with > 1 book:  [ { id: 'user-1', count: 1 } ]
  });
```

> æ³¨æ„ï¼Œæ‚¨å¯ä»¥é“¾æ¥å¤šä¸ª`.where()`æ–¹æ³•æ¥åˆ›å»ºå¤åˆæŸ¥è¯¢ã€‚

### é™åˆ¶å’Œæ’åºæŸ¥è¯¢

æœ‰æ•ˆæŸ¥è¯¢æˆ‘ä»¬çš„é›†åˆçš„å¦ä¸€ä¸ªæ–¹æ³•æ˜¯é™åˆ¶å®ƒä»¬ã€‚å‡è®¾æˆ‘ä»¬å¸Œæœ›å°†ä¸€ä¸ªç»™å®šçš„æŸ¥è¯¢é™åˆ¶åœ¨ä¸€å®šæ•°é‡çš„æ–‡æ¡£ä¸­ã€‚

å¦‚æœæˆ‘ä»¬åªæƒ³ä»æŸ¥è¯¢ä¸­è¿”å›å‡ é¡¹ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ç»™å®šçš„å¼•ç”¨åæ·»åŠ `.limit()`æ–¹æ³•ã€‚

å¦‚æœæˆ‘ä»¬æƒ³é€šè¿‡æŸ¥è¯¢è·å–å·²ç»æäº¤äº†è‡³å°‘ä¸€æœ¬ä¹¦çš„ç”¨æˆ·æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼Œå®ƒçœ‹èµ·æ¥å°±åƒä¸‹é¢è¿™æ ·ã€‚

```
const usersRef = firebase
  .firestore()
  .collection("users")
  .where("count", ">=", 1);

  usersRef.limit(3)
```

å¦ä¸€ä¸ªå¼ºå¤§çš„ç‰¹æ€§æ˜¯ä½¿ç”¨`.orderBy()`æ ¹æ®æ–‡æ¡£å­—æ®µå¯¹æŸ¥è¯¢çš„æ•°æ®è¿›è¡Œæ’åºã€‚

å¦‚æœæˆ‘ä»¬æƒ³æŒ‰ç…§ç”¨æˆ·ç¬¬ä¸€æ¬¡è¢«åˆ›å»ºçš„æ—¶é—´å¯¹å…¶è¿›è¡Œæ’åºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`orderBy`æ–¹æ³•ï¼Œå°†â€œcreatedâ€å­—æ®µä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚å¯¹äºç¬¬äºŒä¸ªå‚æ•°ï¼Œæˆ‘ä»¬æŒ‡å®šå®ƒåº”è¯¥æ˜¯å‡åºè¿˜æ˜¯é™åºã€‚

è¦è·å¾—æŒ‰åˆ›å»ºæ—¶é—´ä»æœ€æ–°åˆ°æœ€æ—©æ’åºçš„æ‰€æœ‰ç”¨æˆ·ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œä»¥ä¸‹æŸ¥è¯¢:

```
const usersRef = firebase
  .firestore()
  .collection("users")
  .where("count", ">=", 1);

  usersRef.orderBy("created", "desc").limit(3);
```

æˆ‘ä»¬å¯ä»¥ç”¨`.limit()`æ¥é“¾æ¥`.orderBy()`ã€‚ä¸ºäº†æ­£å¸¸å·¥ä½œï¼Œ`.limit()`åº”è¯¥åœ¨æœ€åè°ƒç”¨ï¼Œè€Œä¸æ˜¯åœ¨`.orderBy()`ä¹‹å‰ã€‚

## æƒ³è¦ä½ è‡ªå·±çš„å‰¯æœ¬å—ï¼Ÿ

å¦‚æœä½ æƒ³æŠŠè¿™ä¸ªæŒ‡å—ä½œä¸ºå°†æ¥çš„å‚è€ƒï¼Œ[ç‚¹å‡»è¿™é‡Œ](https://reedbarger.com/resources/javascript-firestore-2020/)ä¸‹è½½æ•´ä¸ªæ•™ç¨‹çš„å¤‡å¿˜å•ã€‚

[The Ultimate Firestore Tutorial ğŸ”¥Snag this super in-depth, massive PDF to give you the complete developerâ€™s guide to mastering Firestore including tons of practical examples, copyable code and more.![favicon](img/88eca104b0e1811369e2fc91a8fe7812.png)![w3YyCPKbdEPN9qKQimLo3B](img/45b92828ce751b96b4036663f1392391.png)](https://reedbarger.com/resources/javascript-firestore-2020/)